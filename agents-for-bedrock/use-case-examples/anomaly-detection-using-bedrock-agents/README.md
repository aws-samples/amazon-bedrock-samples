
# Automated Anomaly Detection and Response with Amazon Bedrock

## Solution Overview

The automation example is focused on blocking traffic to and from suspicious remote hosts, for example to IP addresses associated with known command and control servers for botnets. Amazon GuardDuty detection of unintended communication with remote hosts triggers a series of steps, including blocking of network traffic to those hosts by using Network Firewall, and notification of security team. Below is the Solution diagram. 

## **Architecture:**

![Automating Security Hub with Network Firewall Solution](/static/anfw-bedrock-solution.png)

The solution works as follows:

* [Amazon GuardDuty](https://aws.amazon.com/guardduty/) detects unexpected behavior that includes an antivirus threat. GuardDuty generates a finding, in JSON format, that includes details such as the EC2 instance ID involved (if applicable), account information, type of attack, remote IP, and other details. 

* [AWS Security Hub](https://aws.amazon.com/security-hub/) ingests the finding generated by Amazon GuardDuty and consolidates it with findings from other AWS security services. Security Hub also publishes the contents of the finding to an [Amazon EventBridge rule](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-rules.html). You can download a sample finding here [Sample Security Hub Finding](:assetUrl{path="/static/sample-securityHub-Finding.json"})

* Amazon EventBridge has a rule with an event pattern that matches Amazon GuardDuty events that contain the malicious file as shown in the below image. When an event matching the pattern is published on the default bus, Amazon EventBridge routes that event to the designated target, in this case a [AWS Lambda Function](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html) that invokes [Amazon Bedrock Agent](https://aws.amazon.com/bedrock/agents/). AWS Securtity Hub is the source for this EventBridge rule and Amazon GuardDuty ingests this finding into AWS Security Hub. Both Amazon GuardDuty and AWS Security Hub are enabled for this workshop. 

![SecurityHub-EventBridge Rule](/static/SH-GD-Integration.png)

* The AWS Lambda function ingests the details of the AWS Security Hub finding published in Amazon EventBridge and invokes Amazon Bedrock Agent to orchestrate the remediation response through a defined workflow.

* The first step in this orchestration is to record the threat details in Amazon DynamoDB. The Bedrock Agent invokes a Lambda function which creates a record in a [DynamoDB](https://aws.amazon.com/dynamodb/) table with IP address of the suspected malicious host, brief finding summary and time stamp of the activity. The Bedrock Agent uses Bedrock Generative AI capability to extract the information needed from the Dynamo DB table fields stated above from the Security Hub finding xml. You can use these details to investigate the traffic and make necessary actions.

![DynamoDB Table Details](/static/sh-nfw-DDB.png)

* The next step is to retrieve the JA3 hash from [Amazon CloudWatch](https://aws.amazon.com/cloudwatch/) logs which is associated with the IP of malicious host.

* After retrieving JA3 hash, the Bedrock Agent will use Bedrock Generative AI capability to generate a [Suricata rule](https://docs.suricata.io/en/latest/rules/index.html) to block the traffic which is generating the matching JA3 hash. 

* As a final step in this workflow, the Bedrock Agent updates the Network Firewall with the generated Suricata rules and send an email notification about the update to the SNS topic subscribers. 

![DynamoDB Details](/static/after-nfw-update.png)

* A sample email looks as shown in the below image. 

![Sample email Details](/static/Sample-test-7.png)

# Installation

## Prerequisites:

1. Amazon GuardDuty is already enabled in the AWS account.
2. Amazon Bedrock Access and AWS CLI Credentials are configured for the AWS account.
3. Ensure that AWS CLI is installed on your machine. It can be downloaded [here](https://aws.amazon.com/cli/)
4. Ensure Python 3.9+ installed on your machine, it is the most stable version of Python for the packages we will be using, it can be downloaded [here](https://www.python.org/downloads/release/python-3911/).
5. Go to the Amazon Bedrock console, Click on Model Access, Select the Anthropic models and save changes. 
6. Access to us-west-2 as the solution was tested in us-west-2
7. AWS SAM CLI is installed. Instructions [here] (https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)

## Step 1:

The first step of utilizing this repo is performing a git clone of the repository and navigate to the folder.

```
$ git clone https://github.com/aws-samples/amazon-bedrock-samples.git

$ cd amazon-bedrock-samples/agents-for-bedrock/features-examples/10-automated-anomaly-detection-and-response
```

## Step 2:
Execute the cloud formation template with SNS notification email as an input to subscribe for SNS notifications. After initialization, you'll see deployment progress.

Deploiyment can take anywhere from 10 minutes to 30 minutes

# Testing the solution

## Step 3: Generate traffic that creates Amazon CloudWatch logs

**3.a.**  Navigate to `EC2` on AWS Console and select the EC2 instance that is created as part of this CloudFormation deployment  `anfw-bedrock-automation-test-instance`. Click on `Connect`. 

![Generate EC2 traffic](/static/ec2-1.png)

**3.b.** Connect to this EC2 instance using [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html)

![Generate EC2 traffic](/static/ec2-2.png)

**3.c.** Create EICAR test file with the below command. The EICAR.com file is a safe, non-malicious test file used to verify the proper operation of antivirus and anti-malware software by triggering a detection response without causing any harm to the system. If the EICAR.com file is placed in an EC2 instance, GuardDuty will generate a finding by identifying the presence of this file, which is commonly used to simulate malware activity. To generate this file, copy and paste the below command in the EC2 instance session.

echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' >> /home/ssm-user/eicar.com

![Generate EC2 traffic](/static/ec2-3.png)

**3.d.** After copying EICAR.com file, execute the curl command. This command will generate a unique JA3 hash based on the Suricata Rule :code[alert tls any any -> any any (ja3.hash; content:!"00000000000000000000000000000000"; msg:"JA3"; sid:202404221;)] which is currently present in the Network Firewall Rule Group. 

curl -m 5 https://www.google.com

![Generate EC2 traffic](/static/ec2-4.png)

**3.e.** Navigate to `AWS Network Firewall` in AWS Console under the VPC dashboard, click on `Network Firewall Rule groups` and select `suricata-ja3-rule-anfw-bedrock-automation` to verify the Suricata Rule already present in the rule group. This rule is used to log the JA3 hash value for all clients requesting TLS sessions which are inspected by the firewall.  This hash represents unique attributes of how the client negotiates a TLS session and can be used to detect or block traffic from [known malware](https://sslbl.abuse.ch/ja3-fingerprints/) or other unwanted software."

![Generate EC2 traffic](/static/ec2-5.png)

## Step 4. Check Agents for Amazon Bedrock for Orchestration

**4.a.** Check that you have access to Claude 3 models. Navigate to `Amazon Bedrock` in AWS Console and select `Model access` and confirm that access is granted for `Claude 3 Sonnet` 

**4.b.** Navigate to `Amazon Bedrock` in AWS Console and select `Agents` under the Orchestration section. These Agents will orchestrate and execute multistep tasks. Agents orchestrate and analyze the task and break it down into the correct logical sequence using the foundation models reasoning abilities. 

**4.c.** `nfwBedrockAgent` is already created as part of the CloudFormation stack executed. Click on it to review the definition.  This is where you usually select the Large Language Model (LLM) model to use, provide `Instructions for the Agent`, define the `Action groups` with a set of actions to perform, define the `Knowledge bases` which the agent can use for getting contextual content for agent actions, define the `Guardrail details` to block and filter out harmful content if required etc., Review the definition of the agent for your understanding, no need to make any changes here.

**4.d** You will see the list of Aliases available for you to use as seen below. Note down the 10 character alias ID of the latest Alias. 

![Bedrock agents Instructions](/static/Bedrock-18-2.png)

**4.e** Check if the Lambda function invoking Bedrock Agent is using the Alias ID. This will ensure that the latest version of the Amazon Bedrock Agent is initiated whenever a Security Hub finding invokes the Bedrock agent Lambda function. Navigate to Lambda in AWS console and click on `InvokeBedrockAgent` Lambda function. Go to `Configuration` and select `Environment Variables`. You'll see environment variables `BEDROCK_AGENT_ID` and `BEDROCK_AGENT_ALIAS_ID` there as shown in the below image. 

![Bedrock agents Instructions](/static/Bedrock-19.png)

**4.f** Confirm that the Alias ID you noted in Bedrock Agent screen matches with the value of `BEDROCK_AGENT_ALIAS_ID`. If not, edit it to update it with the latest Alias ID. 

![Bedrock agents Instructions](/static/Bedrock-20.png)

## Step 5. Test with a sample AWS Security Hub Finding

**5.a** In this step, you will note down the `Account Number`, `EC2 Instance ID`, `Private IPv4 address`, and `Public IPv4 address` values corresponding to your workshop environment and then create a test JSON by editing the [Sample Security Hub Finding JSON](:assetUrl{path="/static/sample-securityHub-Finding.json"}) to replace `Account Number`, `EC2 Instance ID`, `Private IPv4 address`, and `Public IPv4 address` values in the Sample JSON with your workshop environment values. This Security Hub finding JSON simulates a scenario of GuardDuty identifying a malicious file in your EC2 instance. Using this JSON is a simplest way to test an AWS Security Hub finding without actually generating a Security Hub finding. 

**5.b** Navigate to `EC2` in AWS Console and copy the account number and properties of the EC2 Instance as shown in the below image to get the `Account Number`, `EC2 Instance ID`, `Private IPv4 address`, and `Public IPv4 address` values corresponding to your workshop environment. 

![Sample Security Hub Test](/static/Sample-test-1.png)

**5.c** Copy the [Sample Security Hub Finding JSON](:assetUrl{path="/static/sample-securityHub-Finding.json"}) in to an editor of your choice like Notepad++ or TextEdit or VSCode etc., on your machine. 

**5.d** Edit the sample Security Hub finding JSON to replace the mentioned fields to have the values from your workshop environment. Use the find all / replace all option in your editor to:
    * Replace `999999999999` in sample JSON with `Account Number` noted from your workshop environment in prior step
    * Replace `i-ec2-instance-id` in sample JSON with your `EC2 Instance ID` noted from your workshop environment in prior step
    * Replace `11:11:11:11` in sample JSON with your `Private IPv4 address` noted from your workshop environment in prior step
    * Replace `88:88:88:88` in sample JSON with your `Public IPv4 address` noted from your workshop environment in prior step

**5.e** Navigate to `Lambda` in AWS Console and select `InvokeBedrockAgent` Function.

![Sample Security Hub Test](/static/Sample-test-2.png)

**5.f** Click on `Test` and enter event name as `sample-security-hub-test`. Copy the modified Security Hub finding in `Event JSON`. Click on `Save` and then click `Test`. 

![Sample Security Hub Test](/static/Sample-test-3.png)

**5.g** Test will be completed in few seconds and you can see that execution is succeeded. You can click on Details to understand the steps Agent performed.

![Sample Security Hub Test](/static/Sample-test-4.png)

**5.h** Navigate to `DynamoDB` in AWS Console, Select the table and you can see the IP addresses that Amazon Bedrock Agent created. 

![Sample Security Hub Test](/static/Sample-test-5.png)

**5.i** And now navigate to `AWS Network Firewall` in AWS Console. Click on `Network Firewall Rule groups` and select `suricata-ja3-rule-anfw-bedrock-automation`. Scroll down to `Rules` and you can see the new Suricata Rules created by Amazon Bedrock Agent as shown below. 

![Sample Security Hub Test](/static/Sample-test-6.png)

**5.j** Check the email you received from SNS that explains the remediation steps that Amazon Bedrock Agent performed. 

![Sample Security Hub Test](/static/Sample-test-7.png)


***Congrats! If you have come this far, you have completed the testing of Amazon Bedrock Agent you created in this Lab and evaluated how Amazon Bedrock Agent has orchestrated security automation. In the following steps, you will perform an on-demand scan on EC2 instance using GuardDuty to generate a real time finding and invoke Amazon Bedrock Agent with Amazon EventBridge rule. This is an optional step and it will take several minutes for GuardDuty to generate finding once on-demand scan is initiated. Please follow these steps once you have competed sample testing from Lambda function.

## Step 6. Perform on-demand scan of Amazon EC2 instance with Amazon GuardDuty 

To be able to successfully test with Amazon GuardDuty integration with Bedrock Agent for this use case, you need to delete the entries in Dynamodb and the newly created entry in Network Firewall rule Group. After the entries are manually deleted, you can proceed with the next steps below.

**6.a** `Amazon GuardDuty` is already enabled in the AWS account provided. Navigate to `GuardDuty` in AWS Console and Click on `Malware scans`. You will find an option to `Start new on-demand scan` for starting a malware scan on the EC2 instance provided. Click on `Start new on-demand scan`. 


![GuardDuty on-demand scan](/static/GD-scan-1.png)

**6.b** You need to enter the EC2 instance ARN to Start on-demand malware scan. ARN format for EC2 is `arn:aws:ec2:us-west-2:555555555555:instance/i-1234567890abcdef0`. Modify the instance id and account number of this ARN to create the EC2 instance ARN. Enter in `EC2 instance ARN` and click on `Confirm`. 

![GuardDuty on-demand scan](/static/GD-scan-2.png)

**6.c** After clicking on `Confirm`, you will see an option to `see malware scan details` as shown in the below image. Click on it. 

![GuardDuty on-demand scan](/static/GD-scan-3.png)


**6.d** You will see the scan status and start time of the scan. 

![GuardDuty on-demand scan](/static/GD-scan-4.png)


::alert[After you initiate on-demand malware scan, it can take several minutes to see the results. Hence, we finished a test using the sample finding to validate the Bedrock Agent orchestration within this builders session.]{header="Note"}

**6.e** After the scan is completed, you will see the finding with High severity with Finding type  `Execution:EC2/MaliciousFile` as shown in the below image. 

![GuardDuty on-demand scan](/static/GD-scan-5.png)


## Step 7. Verify finding Ingestion in AWS Security Hub

* Amazon GuardDuty will ingest this finding into AWS Security Hub. Navigate to `Security Hub` in AWS Console and click on `Findings`. You can see the security risk detected by GuardDuty in the Findings. 


![Verify the finding in Security Hub](/static/GD-scan-6.png)

## Step 8. Verify the entries in AWS Network Firewall and Amazon DynamoDB

* Bedrock Agent has invoked multiple Lambda functions that created entries in AWS Network Firewall and Amazon DynamoDB. Navigate to `VPC -> Network Firewall -> Network Firewall Rule groups`. Click on `suricata-ja3-rule-anfw-bedrock-automation` and verify the new Suricata Rule that's added to the existing rules. 

![Verify the finding in Security Hub](/static/nfw-verification.png)

## Step 9. Validate the email notification

* Finally, check your email from AWS Notifications Message and verify the remediations performed by Amazon Bedrock Agent. 

![Verify the finding in Security Hub](/static/sns-verification.png)

### You have explored how you can use AWS Generative AI services [Amazon Bedrock](https://aws.amazon.com/bedrock/) and [Agents for Amazon Bedrock](https://aws.amazon.com/bedrock/agents/)to automatically respond to potential security events within your [Amazon Web Services (AWS)](http://aws.amazon.com/) environment that are detected by [Amazon GuardDuty](https://aws.amazon.com/guardduty/) and update [AWS Network Firewall](https://aws.amazon.com/network-firewall/). The goal is to rapidly contain the impact of security events, while providing additional time for follow-up investigation. You may take inspirations from this solution to continue to build additional automation by adding workflows for your needs.


## Support
Raise a github issue if you find any issues with the solution

## Roadmap
In ideation - Will release soon.