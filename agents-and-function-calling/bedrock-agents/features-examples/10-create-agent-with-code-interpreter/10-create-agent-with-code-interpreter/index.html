<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Amazon Bedrock cookbook website"><meta name=author content=Bedrock-GTM><link href=https://github.amazon-bedrock-samples.com/agents-and-function-calling/bedrock-agents/features-examples/10-create-agent-with-code-interpreter/10-create-agent-with-code-interpreter/ rel=canonical><link href=../../09-create-agent-with-memory/09-create-agent-with-memory/ rel=prev><link href=../../14-create-agent-with-custom-orchestration/custom_orchestration_example/ rel=next><link rel=icon href=../../../../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>Create Agent with Code Interpreter - Amazon Bedrock Recipes</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.6f8fc17f.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="Amazon Bedrock Recipes" class="md-header__button md-logo" aria-label="Amazon Bedrock Recipes" data-md-component=logo> <img src=../../../../../logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Amazon Bedrock Recipes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Create Agent with Code Interpreter </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=purple aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Github: Amazon-Bedrock-Samples </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="Amazon Bedrock Recipes" class="md-nav__button md-logo" aria-label="Amazon Bedrock Recipes" data-md-component=logo> <img src=../../../../../logo.png alt=logo> </a> Amazon Bedrock Recipes </label> <div class=md-nav__source> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Github: Amazon-Bedrock-Samples </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> Intro to Amazon Bedrock </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Intro to Amazon Bedrock </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_1> <label class=md-nav__link for=__nav_2_1_1 id=__nav_2_1_1_label tabindex=0> <span class=md-ellipsis> API Usage </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_1> <span class="md-nav__icon md-icon"></span> API Usage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../introduction-to-bedrock/bedrock_apis/01_invoke_api/ class=md-nav__link> <span class=md-ellipsis> Invoke Model API Example </span> </a> </li> <li class=md-nav__item> <a href=../../../../../introduction-to-bedrock/bedrock_apis/04_agents_api/ class=md-nav__link> <span class=md-ellipsis> Agents API Example </span> </a> </li> <li class=md-nav__item> <a href=../../../../../introduction-to-bedrock/bedrock_apis/03_knowledgebases_api/ class=md-nav__link> <span class=md-ellipsis> Knowledge Bases API Example </span> </a> </li> <li class=md-nav__item> <a href=../../../../../introduction-to-bedrock/bedrock_apis/02_guardrails_api/ class=md-nav__link> <span class=md-ellipsis> Guardrail API Example </span> </a> </li> <li class=md-nav__item> <a href=../../../../../introduction-to-bedrock/converse_api/01_converse_api/ class=md-nav__link> <span class=md-ellipsis> Converse API Example </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Agents </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Agents </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1 checked> <label class=md-nav__link for=__nav_2_2_1 id=__nav_2_2_1_label tabindex=0> <span class=md-ellipsis> Amazon Bedrock Agents </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> Amazon Bedrock Agents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../introduction-to-agents/how_to_create_custom_agents/ class=md-nav__link> <span class=md-ellipsis> How to create an Agent </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_2 checked> <label class=md-nav__link for=__nav_2_2_1_2 id=__nav_2_2_1_2_label tabindex=0> <span class=md-ellipsis> Bedrock Agent Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2_2_1_2> <span class="md-nav__icon md-icon"></span> Bedrock Agent Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-create-agent-with-function-definition/01-create-agent-with-function-definition/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Function Definition </span> </a> </li> <li class=md-nav__item> <a href=../../02-create-agent-with-api-schema/02-create-agent-with-api-schema/ class=md-nav__link> <span class=md-ellipsis> Create Agent with API Schema </span> </a> </li> <li class=md-nav__item> <a href=../../03-create-agent-with-return-of-control/03-create-agent-with-return-of-control/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Return of Control </span> </a> </li> <li class=md-nav__item> <a href=../../04-create-agent-with-single-knowledge-base/04-create-agent-with-single-knowledge-base/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Single Knowledge Base </span> </a> </li> <li class=md-nav__item> <a href=../../05-create-agent-with-knowledge-base-and-action-group/05-create-agent-with-knowledge-base-and-action-group/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Knowledge Base and Action Group </span> </a> </li> <li class=md-nav__item> <a href=../../06-prompt-and-session-attributes/06-prompt-and-session-attributes/ class=md-nav__link> <span class=md-ellipsis> Prompt and Session Attributes </span> </a> </li> <li class=md-nav__item> <a href=../../07-advanced-prompts-and-custom-parsers/07-custom-prompt-and-lambda-parsers/ class=md-nav__link> <span class=md-ellipsis> Custom Prompt and Lambda Parsers </span> </a> </li> <li class=md-nav__item> <a href=../../08-create-agent-with-guardrails/08-create-agent-with-guardrails/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Guardrails </span> </a> </li> <li class=md-nav__item> <a href=../../09-create-agent-with-memory/09-create-agent-with-memory/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Memory </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Create Agent with Code Interpreter </span> </a> </li> <li class=md-nav__item> <a href=../../14-create-agent-with-custom-orchestration/custom_orchestration_example/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Custom Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../15-invoke-inline-agents/inline-agent-api-usage/ class=md-nav__link> <span class=md-ellipsis> Create Dynamic Tooling Inline Agents </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_3> <label class=md-nav__link for=__nav_2_2_1_3 id=__nav_2_2_1_3_label tabindex=0> <span class=md-ellipsis> Bedrock Flows </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1_3> <span class="md-nav__icon md-icon"></span> Bedrock Flows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../bedrock-flows/Getting_started_with_Prompt_Management_Flows/ class=md-nav__link> <span class=md-ellipsis> Getting Started with Prompt Management Flows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_4> <label class=md-nav__link for=__nav_2_2_1_4 id=__nav_2_2_1_4_label tabindex=0> <span class=md-ellipsis> Use Case Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1_4> <span class="md-nav__icon md-icon"></span> Use Case Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../use-case-examples/text-2-sql-agent/create_and_invoke_sql_agent/ class=md-nav__link> <span class=md-ellipsis> Text to SQL Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../use-case-examples/agentsforbedrock-retailagent/workshop/test_retailagent_agentsforbedrock/ class=md-nav__link> <span class=md-ellipsis> Retail Agent Workshop </span> </a> </li> <li class=md-nav__item> <a href=../../../use-case-examples/product-review-agent/main/ class=md-nav__link> <span class=md-ellipsis> Product Review Agent </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> <span class=md-ellipsis> Function Calling </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> Function Calling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../function-calling/function_calling_with_converse/function_calling_with_converse/ class=md-nav__link> <span class=md-ellipsis> Function Calling with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../../function-calling/function_calling_with_invoke/function_calling_model_with_invoke/ class=md-nav__link> <span class=md-ellipsis> Function Calling with Invoke </span> </a> </li> <li class=md-nav__item> <a href=../../../../function-calling/return_of_control/return_of_control/ class=md-nav__link> <span class=md-ellipsis> Return of Control </span> </a> </li> <li class=md-nav__item> <a href=../../../../function-calling/tool_binding/tool_bindings/ class=md-nav__link> <span class=md-ellipsis> Tool Binding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3> <label class=md-nav__link for=__nav_2_2_3 id=__nav_2_2_3_label tabindex=0> <span class=md-ellipsis> Open Source </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> Open Source </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_1> <label class=md-nav__link for=__nav_2_2_3_1 id=__nav_2_2_3_1_label tabindex=0> <span class=md-ellipsis> CrewAI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_1> <span class="md-nav__icon md-icon"></span> CrewAI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../open-source-agents/crew.ai/Find%20dream%20destination%20with%20CrewAI/ class=md-nav__link> <span class=md-ellipsis> Find Dream Destination with CrewAI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_2> <label class=md-nav__link for=__nav_2_2_3_2 id=__nav_2_2_3_2_label tabindex=0> <span class=md-ellipsis> LangGraph </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_2> <span class="md-nav__icon md-icon"></span> LangGraph </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/langgraph-single-agent/ class=md-nav__link> <span class=md-ellipsis> LangGraph Agent with Function Calling </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/langgraph-agents-multimodal/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi-Modal Agent with Function Calling </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/langgraph-multi-agent-sql-tools/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/02_medibot_V3_agents/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent For Medical Chatbot </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/langgraph-fact-checker-feedback-loop/ class=md-nav__link> <span class=md-ellipsis> LangGraph Fact Checker with Multi Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/langgraph-multi-agent-sql-tools/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/03_langgraph_agents_of_agent/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent with tools </span> </a> </li> <li class=md-nav__item> <a href=../../../../open-source-agents/langgraph/Travel_planner_with_langgraph/ class=md-nav__link> <span class=md-ellipsis> Managing Memory for Multi Agents </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_3> <label class=md-nav__link for=__nav_2_2_3_3 id=__nav_2_2_3_3_label tabindex=0> <span class=md-ellipsis> Multi Agent </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_3> <span class="md-nav__icon md-icon"></span> Multi Agent </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../introduction-to-agents/how_to_create_multi_agents_from_custom_agents/ class=md-nav__link> <span class=md-ellipsis> Multi Agent Orchestration </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> RAG </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> RAG </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1> <label class=md-nav__link for=__nav_2_3_1 id=__nav_2_3_1_label tabindex=0> <span class=md-ellipsis> Amazon Bedrock Knowledge Bases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1> <span class="md-nav__icon md-icon"></span> Amazon Bedrock Knowledge Bases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_1> <label class=md-nav__link for=__nav_2_3_1_1 id=__nav_2_3_1_1_label tabindex=0> <span class=md-ellipsis> Zero Setup </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_1> <span class="md-nav__icon md-icon"></span> Zero Setup </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/00-zero-setup-chat-with-your-document/chat_with_document_kb/ class=md-nav__link> <span class=md-ellipsis> Chat with Your Document </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_2> <label class=md-nav__link for=__nav_2_3_1_2 id=__nav_2_3_1_2_label tabindex=0> <span class=md-ellipsis> RAG Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_2> <span class="md-nav__icon md-icon"></span> RAG Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/01-rag-concepts/01_create_ingest_documents_test_kb_multi_ds/ class=md-nav__link> <span class=md-ellipsis> Create and Ingest Documents with Multi-Data Sources </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/01-rag-concepts/02_managed_rag_custom_prompting_and_no_of_results/ class=md-nav__link> <span class=md-ellipsis> Managed RAG with Custom Prompting </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/01-rag-concepts/03_customized-rag-retreive-api-hybrid-search-claude-3-sonnet-langchain/ class=md-nav__link> <span class=md-ellipsis> Customized RAG with Claude 3 and Langchain </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/01-rag-concepts/04_customized-rag-retreive-api-langchain-claude-evaluation-ragas/ class=md-nav__link> <span class=md-ellipsis> RAG Evaluation with Langchain and RAGAS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_3> <label class=md-nav__link for=__nav_2_3_1_3 id=__nav_2_3_1_3_label tabindex=0> <span class=md-ellipsis> Optimizing Retrieval Results </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_3> <span class="md-nav__icon md-icon"></span> Optimizing Retrieval Results </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/advanced_chunking_options/ class=md-nav__link> <span class=md-ellipsis> Advanced Chunking Options </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/csv_metadata_customization/ class=md-nav__link> <span class=md-ellipsis> CSV Metadata Customization </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/query_reformulation/ class=md-nav__link> <span class=md-ellipsis> Query Reformulation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_4> <label class=md-nav__link for=__nav_2_3_1_4 id=__nav_2_3_1_4_label tabindex=0> <span class=md-ellipsis> Advanced Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_4> <span class="md-nav__icon md-icon"></span> Advanced Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/03-advanced-concepts/dynamic-metadata-filtering/dynamic-metadata-filtering-KB/ class=md-nav__link> <span class=md-ellipsis> Dynamic Metadata Filtering </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_4_2> <label class=md-nav__link for=__nav_2_3_1_4_2 id=__nav_2_3_1_4_2_label tabindex=0> <span class=md-ellipsis> Reranking </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_4_2> <span class="md-nav__icon md-icon"></span> Reranking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/01_deploy-reranking-model-sm/ class=md-nav__link> <span class=md-ellipsis> Deploy Reranking Model </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/02_kb-reranker/ class=md-nav__link> <span class=md-ellipsis> Knowledge Base Reranker </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/qa-generator/ class=md-nav__link> <span class=md-ellipsis> QA Generator </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_5> <label class=md-nav__link for=__nav_2_3_1_5 id=__nav_2_3_1_5_label tabindex=0> <span class=md-ellipsis> Responsible AI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_5> <span class="md-nav__icon md-icon"></span> Responsible AI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/features-examples/05-responsible-ai/contextual-grounding/ class=md-nav__link> <span class=md-ellipsis> Contextual Grounding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6> <label class=md-nav__link for=__nav_2_3_1_6 id=__nav_2_3_1_6_label tabindex=0> <span class=md-ellipsis> Use Case Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6> <span class="md-nav__icon md-icon"></span> Use Case Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6_1> <label class=md-nav__link for=__nav_2_3_1_6_1 id=__nav_2_3_1_6_1_label tabindex=0> <span class=md-ellipsis> Metadata Filter Access Control </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6_1> <span class="md-nav__icon md-icon"></span> Metadata Filter Access Control </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/use-case-examples/metadata-filter-access-control/kb-end-to-end-acl/ class=md-nav__link> <span class=md-ellipsis> End-to-End ACL with Knowledge Base </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6_2> <label class=md-nav__link for=__nav_2_3_1_6_2 id=__nav_2_3_1_6_2_label tabindex=0> <span class=md-ellipsis> RAG with Structured and Unstructured Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6_2> <span class="md-nav__icon md-icon"></span> RAG with Structured and Unstructured Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/0-create-dummy-structured-data/ class=md-nav__link> <span class=md-ellipsis> Create Dummy Structured Data </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/1_create_sql_dataset_optional/ class=md-nav__link> <span class=md-ellipsis> Create SQL Dataset (Optional) </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/2_rag_with_structured_unstructured_data/ class=md-nav__link> <span class=md-ellipsis> RAG with Structured and Unstructured Data </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2> <label class=md-nav__link for=__nav_2_3_2 id=__nav_2_3_2_label tabindex=0> <span class=md-ellipsis> Open Source </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_2> <span class="md-nav__icon md-icon"></span> Open Source </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/open-source/chatbots/qa_chatbot_langchain_bedrock/ class=md-nav__link> <span class=md-ellipsis> Chatbot using Langchain </span> </a> </li> <li class=md-nav__item> <a href=../../../../../rag/open-source/chunking/rag_chunking_strategies_langchain_bedrock/ class=md-nav__link> <span class=md-ellipsis> Chunking strategies for RAG applications </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2_3> <label class=md-nav__link for=__nav_2_3_2_3 id=__nav_2_3_2_3_label tabindex=0> <span class=md-ellipsis> Vector Stores </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_2_3> <span class="md-nav__icon md-icon"></span> Vector Stores </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../rag/open-source/vector_stores/rag_langchain_bedrock_opensearch/ class=md-nav__link> <span class=md-ellipsis> Langchain Chatbot with Opensearch </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> Model Customization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Model Customization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../custom-models/model-distillation/Historical_invocation_distillation/ class=md-nav__link> <span class=md-ellipsis> Model Distillation with Invocation Logs </span> </a> </li> <li class=md-nav__item> <a href=../../../../../custom-models/model-distillation/Distillation-via-S3-input/ class=md-nav__link> <span class=md-ellipsis> Model Distillation with S3 Data </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Gen AI Usecases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Gen AI Usecases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Text Generation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Text Generation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../genai-use-cases/text-generation/how_to_work_with_text_generation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Streaming Response with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../../../genai-use-cases/text-generation/how_to_work_with_code_generation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Generate Python Code with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../../../genai-use-cases/text-generation/how_to_work_with_text_translation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Text Translation with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../../../genai-use-cases/text-generation/how_to_work_with_text-summarization-titan%2Bclaude/ class=md-nav__link> <span class=md-ellipsis> Text summarization with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../../../genai-use-cases/text-generation/how_to_work_with_batch_example_for_multi_threaded_invocation/ class=md-nav__link> <span class=md-ellipsis> Generate Bulk Emails with Batch Inference </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Workshops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Workshops </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> Open-source L400 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Open-source L400 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/01_usecase_introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction to the Use Case </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/02_Lab_Find%20a%20Dream%20Destination_RAG%20query/ class=md-nav__link> <span class=md-ellipsis> Advanced RAG for Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/02_travel_planner_with_langgraph/ class=md-nav__link> <span class=md-ellipsis> Conversational Memory in Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/03_travel_agent_with_tools/ class=md-nav__link> <span class=md-ellipsis> Multi-Modal and Types of Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/04_travel_booking_multi_agent/ class=md-nav__link> <span class=md-ellipsis> Multi-Agent Collaboration with Human-in-loop </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/05_dream_destination_with_crewai/ class=md-nav__link> <span class=md-ellipsis> Find Dream Destination with CrewAI </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/06_agent_evaluation_with_ragas/ class=md-nav__link> <span class=md-ellipsis> RAGAs Agents Evaluation </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l400/07_dynamic_tooling_agents/ class=md-nav__link> <span class=md-ellipsis> Dynamic Tool invocation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Open-source L200 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Open-source L200 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l200/02_contextual_text_generation/ class=md-nav__link> <span class=md-ellipsis> Introduction to the Use Case </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l200/03_retrieval_based_text_application/ class=md-nav__link> <span class=md-ellipsis> Retrieval Based Text Generation </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l200/04_retrieval_based_chat_application/ class=md-nav__link> <span class=md-ellipsis> Retrieval Based Chat Application </span> </a> </li> <li class=md-nav__item> <a href=../../../../../workshop/open-source-l200/05_agent_based_text_generation/ class=md-nav__link> <span class=md-ellipsis> Agent Based Text Generation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../general/tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> <li class=md-nav__item> <a href=../../../../../general/license/ class=md-nav__link> <span class=md-ellipsis> License </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../../../general/tags/#agent-code-interpreter class="md-tag md-tag-icon">Agent/ Code-Interpreter</a> <a href=../../../../../general/tags/#api-usage-example class="md-tag md-tag-icon">API-Usage-Example</a> <a href=../../../../../general/tags/#agents-function-calling class="md-tag md-tag-icon">Agents/ Function Calling</a> </nav> <h1>Create Agent with Code Interpreter</h1> <div class="admonition tip inline end"> <p class=admonition-title><a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/agents-and-function-calling/bedrock-agents/features-examples/10-create-agent-with-code-interpreter/10-create-agent-with-code-interpreter.ipynb target=_blank>Open in github</a></p> </div> <h2>Create Agent with Code Interpreter</h2> <p>In this notebook we will create an Agent for Amazon Bedrock using the new capabilities for code interpreter to execute code. Code interpreter is a special pre-defined tool (action group) that provides the model with a sandbox environment in which it can execute code (currently Python), using a set of available pre-defined libraries.</p> <p>The example will first use code interpreter to help answer math questions. LLMs often struggle with accuracy on math, but are proficient in writing code, so the agent will write code to perform its math calculations, use code interpreter to execute it, and pass the results back to the user. We will also show how to pass files into the agent, either for chat processing or for analysis using code interpretation. Finally, the agent will use code interpreter to write code to create files of types that it normally could not, such as graphs.</p> <p>Examples: * Create agent with code interpretation * Invoke agent asking for some math questions * Invoke agent passing a file for chat * Invoke agent passing a file for code interpretation * Invoke agent to plot a graph * Invoke agent to create documents</p> <p>The following architecture will be built:</p> <p><img alt="Code interpreter agent" src=../images/architecture.png></p> <h2>Prerequisites</h2> <p>Before starting, let's update the botocore and boto3 packages to ensure we have the latest version</p> <div class=highlight><pre><span></span><code><span class=err>!</span><span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>--</span><span class=n>upgrade</span> <span class=o>-</span><span class=n>q</span> <span class=n>boto3</span>
<span class=err>!</span><span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>--</span><span class=n>upgrade</span> <span class=o>-</span><span class=n>q</span> <span class=n>botocore</span>
<span class=err>!</span><span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=o>--</span><span class=n>upgrade</span> <span class=o>-</span><span class=n>q</span> <span class=n>awscli</span>
</code></pre></div> <p>Let's now check the boto3 version to ensure the correct version has been installed. Your version should be greater than or equal to 1.34.139.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>import</span> <span class=nn>botocore</span>
<span class=kn>import</span> <span class=nn>awscli</span>
<span class=nb>print</span><span class=p>(</span><span class=n>boto3</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>botocore</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>awscli</span><span class=o>.</span><span class=n>__version__</span><span class=p>)</span>
</code></pre></div> <p>Next we want to import the support packages and set the logger object</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>json</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=kn>from</span> <span class=nn>io</span> <span class=kn>import</span> <span class=n>BytesIO</span>
<span class=kn>import</span> <span class=nn>uuid</span>
<span class=kn>import</span> <span class=nn>pprint</span>
<span class=kn>import</span> <span class=nn>logging</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>setting</span> <span class=n>logger</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;[</span><span class=si>%(asctime)s</span><span class=s1>] p</span><span class=si>%(process)s</span><span class=s1> {</span><span class=si>%(filename)s</span><span class=s1>:</span><span class=si>%(lineno)d</span><span class=s1>} </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
<span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</code></pre></div> <p>Let's now create the boto3 clients for the required AWS services</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>getting</span> <span class=n>boto3</span> <span class=n>clients</span> <span class=k>for</span> <span class=n>required</span> <span class=n>AWS</span> <span class=n>services</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>sts_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;sts&#39;</span><span class=p>)</span>
<span class=n>iam_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iam&#39;</span><span class=p>)</span>
<span class=n>lambda_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;lambda&#39;</span><span class=p>)</span>
<span class=n>bedrock_agent_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;bedrock-agent&#39;</span><span class=p>)</span>
<span class=n>bedrock_agent_runtime_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;bedrock-agent-runtime&#39;</span><span class=p>)</span>
</code></pre></div> <p>Next we can set some configuration variables for the agent and for the lambda function being created</p> <div class=highlight><pre><span></span><code><span class=n>session</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
<span class=n>region</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>region_name</span>
<span class=n>account_id</span> <span class=o>=</span> <span class=n>sts_client</span><span class=o>.</span><span class=n>get_caller_identity</span><span class=p>()[</span><span class=s2>&quot;Account&quot;</span><span class=p>]</span>
<span class=n>region</span><span class=p>,</span> <span class=n>account_id</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>configuration</span> <span class=n>variables</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>suffix</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>region</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>account_id</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=n>agent_name</span> <span class=o>=</span> <span class=s2>&quot;assistant-w-code-interpret&quot;</span>
<span class=n>agent_bedrock_allow_policy_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>agent_name</span><span class=si>}</span><span class=s2>-ba-</span><span class=si>{</span><span class=n>suffix</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=n>agent_role_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;AmazonBedrockExecutionRoleForAgents_</span><span class=si>{</span><span class=n>agent_name</span><span class=si>}</span><span class=s1>&#39;</span>
<span class=n>agent_foundation_model</span> <span class=o>=</span> <span class=s2>&quot;anthropic.claude-3-sonnet-20240229-v1:0&quot;</span>
<span class=n>agent_description</span> <span class=o>=</span> <span class=s2>&quot;Assistant with code interpreter that can write and execute code to answer questions&quot;</span>
<span class=n>agent_instruction</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>You are an assistant that helps customers answer questions and create documents.</span>
<span class=s2>You have access to code interpreter to execute Python code, so when tasks are best handled via Python code, </span>
<span class=s2>write code as needed and pass it to code interpreter to execute, then return the result to the user.</span>
<span class=s2>&quot;&quot;&quot;</span>
<span class=n>agent_alias_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>agent_name</span><span class=si>}</span><span class=s2>-alias&quot;</span>
</code></pre></div> <h2>Create synthetic stock price data</h2> <p>We will use a CSV of stock price data for the non-existent company 'FAKECO'; we create it here.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
<span class=k>def</span> <span class=nf>make_synthetic_stock_data</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
    <span class=c1># Define the start and end dates</span>
    <span class=n>start_date</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>2023</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>27</span><span class=p>)</span>
    <span class=n>end_date</span> <span class=o>=</span> <span class=n>datetime</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>27</span><span class=p>)</span>

    <span class=c1># Create a date range</span>
    <span class=n>date_range</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>date_range</span><span class=p>(</span><span class=n>start_date</span><span class=p>,</span> <span class=n>end_date</span><span class=p>,</span> <span class=n>freq</span><span class=o>=</span><span class=s1>&#39;D&#39;</span><span class=p>)</span>

    <span class=c1># Initialize lists to store the data</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>dates</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>open_prices</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>high_prices</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>low_prices</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>close_prices</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>adj_close_prices</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>volumes</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=c1># Set the initial stock price</span>
    <span class=n>initial_price</span> <span class=o>=</span> <span class=mf>100.0</span>

    <span class=c1># Generate plausible stock prices</span>
    <span class=k>for</span> <span class=n>date</span> <span class=ow>in</span> <span class=n>date_range</span><span class=p>:</span>
        <span class=n>symbol</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;FAKECO&#39;</span><span class=p>)</span>
        <span class=n>dates</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>date</span><span class=p>)</span>
        <span class=n>open_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=n>initial_price</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>high_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=n>open_price</span> <span class=o>+</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>low_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=n>open_price</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>close_price</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=n>low_price</span><span class=p>,</span> <span class=n>high_price</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span>
        <span class=n>adj_close_price</span> <span class=o>=</span> <span class=n>close_price</span>
        <span class=n>volume</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>10000000</span><span class=p>)</span>

        <span class=n>open_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>open_price</span><span class=p>)</span>
        <span class=n>high_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>high_price</span><span class=p>)</span>
        <span class=n>low_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>low_price</span><span class=p>)</span>
        <span class=n>close_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>close_price</span><span class=p>)</span>
        <span class=n>adj_close_prices</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>adj_close_price</span><span class=p>)</span>
        <span class=n>volumes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>volume</span><span class=p>)</span>

        <span class=n>initial_price</span> <span class=o>=</span> <span class=n>close_price</span>

    <span class=c1># Create a DataFrame</span>
    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;Symbol&#39;</span><span class=p>:</span> <span class=n>symbol</span><span class=p>,</span>
        <span class=s1>&#39;Date&#39;</span><span class=p>:</span> <span class=n>dates</span><span class=p>,</span>
        <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=n>open_prices</span><span class=p>,</span>
        <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=n>high_prices</span><span class=p>,</span>
        <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=n>low_prices</span><span class=p>,</span>
        <span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=n>close_prices</span><span class=p>,</span>
        <span class=s1>&#39;Adj Close&#39;</span><span class=p>:</span> <span class=n>adj_close_prices</span><span class=p>,</span>
        <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=n>volumes</span>
    <span class=p>}</span>

    <span class=n>stock_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

    <span class=c1># Save the dataframe</span>
    <span class=n>stock_data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Insure</span> <span class=n>the</span> <span class=n>output</span> <span class=n>directory</span> <span class=n>exists</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=kn>import</span> <span class=nn>os</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>):</span>
    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>)</span>

<span class=n>stock_file</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>,</span> <span class=s1>&#39;FAKECO.csv&#39;</span><span class=p>)</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>stock_file</span><span class=p>):</span>
    <span class=n>make_synthetic_stock_data</span><span class=p>(</span><span class=n>stock_file</span><span class=p>)</span>
</code></pre></div> <h2>Create Agent</h2> <p>We will now create the agent. To do so, we first need to create the agent policies that allow bedrock model invocation for a specific foundation model and the agent IAM role with the policy associated to it. </p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Create</span> <span class=n>IAM</span> <span class=n>policies</span> <span class=k>for</span> <span class=n>agent</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>bedrock_agent_bedrock_allow_policy_statement</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=s2>&quot;2012-10-17&quot;</span><span class=p>,</span>
    <span class=s2>&quot;Statement&quot;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span>
            <span class=s2>&quot;Sid&quot;</span><span class=p>:</span> <span class=s2>&quot;AmazonBedrockAgentBedrockFoundationModelPolicy&quot;</span><span class=p>,</span>
            <span class=s2>&quot;Effect&quot;</span><span class=p>:</span> <span class=s2>&quot;Allow&quot;</span><span class=p>,</span>
            <span class=s2>&quot;Action&quot;</span><span class=p>:</span> <span class=s2>&quot;bedrock:InvokeModel&quot;</span><span class=p>,</span>
            <span class=s2>&quot;Resource&quot;</span><span class=p>:</span> <span class=p>[</span>
                <span class=sa>f</span><span class=s2>&quot;arn:aws:bedrock:</span><span class=si>{</span><span class=n>region</span><span class=si>}</span><span class=s2>::foundation-model/</span><span class=si>{</span><span class=n>agent_foundation_model</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>]</span>
        <span class=p>}</span>
    <span class=p>]</span>
<span class=p>}</span>

<span class=n>bedrock_policy_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>bedrock_agent_bedrock_allow_policy_statement</span><span class=p>)</span>

<span class=n>agent_bedrock_policy</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>create_policy</span><span class=p>(</span>
    <span class=n>PolicyName</span><span class=o>=</span><span class=n>agent_bedrock_allow_policy_name</span><span class=p>,</span>
    <span class=n>PolicyDocument</span><span class=o>=</span><span class=n>bedrock_policy_json</span>
<span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Create</span> <span class=n>IAM</span> <span class=n>Role</span> <span class=k>for</span> <span class=n>the</span> <span class=n>agent</span> <span class=ow>and</span> <span class=n>attach</span> <span class=n>IAM</span> <span class=n>policies</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>assume_role_policy_document</span> <span class=o>=</span> <span class=n>assume_role_policy_document</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=s2>&quot;2012-10-17&quot;</span><span class=p>,</span>
    <span class=s2>&quot;Statement&quot;</span><span class=p>:</span> <span class=p>[{</span>
          <span class=s2>&quot;Effect&quot;</span><span class=p>:</span> <span class=s2>&quot;Allow&quot;</span><span class=p>,</span>
          <span class=s2>&quot;Principal&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>&quot;Service&quot;</span><span class=p>:</span> <span class=s2>&quot;bedrock.amazonaws.com&quot;</span>
          <span class=p>},</span>
          <span class=s2>&quot;Action&quot;</span><span class=p>:</span> <span class=s2>&quot;sts:AssumeRole&quot;</span>
    <span class=p>}]</span>
<span class=p>}</span>

<span class=n>assume_role_policy_document_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>assume_role_policy_document</span><span class=p>)</span>
<span class=n>agent_role</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>create_role</span><span class=p>(</span>
    <span class=n>RoleName</span><span class=o>=</span><span class=n>agent_role_name</span><span class=p>,</span>
    <span class=n>AssumeRolePolicyDocument</span><span class=o>=</span><span class=n>assume_role_policy_document_json</span>
<span class=p>)</span>

<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Pause</span> <span class=n>to</span> <span class=n>make</span> <span class=n>sure</span> <span class=n>role</span> <span class=ow>is</span> <span class=n>created</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>

<span class=n>iam_client</span><span class=o>.</span><span class=n>attach_role_policy</span><span class=p>(</span>
    <span class=n>RoleName</span><span class=o>=</span><span class=n>agent_role_name</span><span class=p>,</span>
    <span class=n>PolicyArn</span><span class=o>=</span><span class=n>agent_bedrock_policy</span><span class=p>[</span><span class=s1>&#39;Policy&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
<span class=p>)</span>
</code></pre></div> <h3>Creating the Bedrock agent</h3> <p>Once the needed IAM role is created, we can use the Bedrock Agent client to create a new agent. To do so we use the <code>create_agent</code> function. It requires an agent name, underlying foundation model and instructions. You can also provide an agent description. Note that the agent created is not yet prepared. Later, we will prepare and use the agent.</p> <p>You cannot set the agent to use code interpreter at create time; because code interpreter is a special action group, that is done when creating the action group, below.</p> <div class=highlight><pre><span></span><code><span class=n>response</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>create_agent</span><span class=p>(</span>
    <span class=n>agentName</span><span class=o>=</span><span class=n>agent_name</span><span class=p>,</span>
    <span class=n>agentResourceRoleArn</span><span class=o>=</span><span class=n>agent_role</span><span class=p>[</span><span class=s1>&#39;Role&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>],</span>
    <span class=n>description</span><span class=o>=</span><span class=n>agent_description</span><span class=p>,</span>
    <span class=n>idleSessionTTLInSeconds</span><span class=o>=</span><span class=mi>1800</span><span class=p>,</span>
    <span class=n>foundationModel</span><span class=o>=</span><span class=n>agent_foundation_model</span><span class=p>,</span>
    <span class=n>instruction</span><span class=o>=</span><span class=n>agent_instruction</span>
<span class=p>)</span>
<span class=n>response</span>
</code></pre></div> <p>Let's now store the agent id in a local variable to use it on subsequent steps.</p> <div class=highlight><pre><span></span><code><span class=n>agent_id</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;agent&#39;</span><span class=p>][</span><span class=s1>&#39;agentId&#39;</span><span class=p>]</span>
<span class=n>agent_id</span>
</code></pre></div> <h3>Create Agent Action Group</h3> <p>In Bedrock agents, action groups define tools for the agent to use. We will now create an agent action group to provide the agent with code interpreter, a runtime environment for evaluating code. Action groups can also define other tools, such as lambda functions, and can also define a channel for the model to solicit clarifying input from the user if needed (treating the user as a tool that the model can invoke). Our action group, however, just defines the code interpreter. This is done via a special access parameter, parentActionGroupSignature (see <a href=https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/bedrock-agent/client/create_agent_action_group.html>boto3 documentation</a>)</p> <p>To allow your agent to generate, run, and troubleshoot code when trying to complete a task, set <code>parentActionGroupSignature=AMAZON.CodeInterpreter</code>. You must leave the description, apiSchema, and actionGroupExecutor fields blank for this action group.</p> <p>Note that you can also define an action group with parentActionGroupSignature set to the special value <code>AMAZON.UserInput</code>. If this is set, then during orchestration, if your agent determines that it needs to invoke an API in an action group, but doesn’t have enough information to complete the API request, it will invoke this action group instead and return an Observation reprompting the user for more information. User input is appropriate if you know the interaction has a human in the loop. We do not do that here.</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Pause</span> <span class=n>to</span> <span class=n>make</span> <span class=n>sure</span> <span class=n>agent</span> <span class=ow>is</span> <span class=n>created</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span>
<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Now</span><span class=p>,</span> <span class=n>we</span> <span class=n>can</span> <span class=n>configure</span> <span class=ow>and</span> <span class=n>create</span> <span class=n>an</span> <span class=n>action</span> <span class=n>group</span> <span class=n>here</span><span class=p>:</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>

<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Enable</span> <span class=n>code</span> <span class=n>interpretation</span> <span class=k>for</span> <span class=n>the</span> <span class=n>agent</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>agent_action_group_response</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>create_agent_action_group</span><span class=p>(</span>
    <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span><span class=p>,</span>       
    <span class=n>agentVersion</span><span class=o>=</span><span class=s1>&#39;DRAFT&#39;</span><span class=p>,</span>
    <span class=n>actionGroupName</span><span class=o>=</span><span class=s1>&#39;code-interpreter&#39;</span><span class=p>,</span>
    <span class=n>parentActionGroupSignature</span><span class=o>=</span><span class=s1>&#39;AMAZON.CodeInterpreter&#39;</span><span class=p>,</span>
    <span class=n>actionGroupState</span><span class=o>=</span><span class=s1>&#39;ENABLED&#39;</span>
<span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=n>agent_action_group_response</span>
</code></pre></div> <h3>Preparing Agent</h3> <p>Let's create a DRAFT version of the agent that can be used for internal testing.</p> <div class=highlight><pre><span></span><code><span class=n>response</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>prepare_agent</span><span class=p>(</span>
    <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span>
<span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Pause</span> <span class=n>to</span> <span class=n>make</span> <span class=n>sure</span> <span class=n>agent</span> <span class=ow>is</span> <span class=n>prepared</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span>

<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Extract</span> <span class=n>the</span> <span class=n>agentAliasId</span> <span class=kn>from</span> <span class=nn>the</span> <span class=n>response</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>agent_alias_id</span> <span class=o>=</span> <span class=s2>&quot;TSTALIASID&quot;</span>
</code></pre></div> <h2>Invoking the agent</h2> <p>We will now define a helper function to invoke the agent and parse its responses, then invoke it to see it use code invocation.</p> <h3>Define a helper function for agent invocation</h3> <p>This helper function can invoke your agent and parse the stream of returned responses. </p> <p><em>Note: This helper function differs from the one used in similar examples by also defining a show_code_use parameter, which will cause the helper to print a message if the agent invokes the code interpreter, and also has the event stream parsing separated into another helper function <code>process_response</code>. Later in the notebook we will replace <code>process_response</code> with a more elaborate version that can capture returned files and output more richly formatted data</em></p> <p>The <code>invoke_agent_helper</code> function allows the user to send a <code>query</code> to the agent with a <code>session_id</code>. A session defines a turn of back and forward conversations that a user has with the agent. The agent can remember the full context inside of a session. Once the user ends a session, this context is removed.</p> <p>The user can then decide to enable trace or not using the <code>enable_trace</code> boolean variable and to pass a session state as a dictionary via the <code>session_state</code> variable.</p> <p>If a new <code>session_id</code> is provided, the agent will create a new conversation without previous context. If the same <code>session_id</code> is reused, the conversation context related to that session is known by the agent.</p> <p>If the <code>enable_trace</code> is set to <code>True</code>, each response from the agent is accompanied by a <em>trace</em> that details the step being orchestrated by the agent. It allows you to follow the agent's (reasoning via Chain of Thoughts prompting) that led to the final response at that point of the conversation.</p> <p>To handle the memory capabilities the <code>memory_id</code> parameter is used. Once a session is ended, it will summarize the content into a new session id as part of the <code>memory_id</code>.</p> <p>You can also pass a session context using the <code>session_state</code> parameter. The session state allows you to share the following information with the agent: - <strong><code>sessionAttributes</code></strong>: attributes that persist over a session between the user and the agent. All invokeAgent calls with the same session_id belong to the same sesison and will have the sessionAttributes shared with them as long as the session time limit has not being surpassed and the user has not ended the session. The sessionAttributes are available in the lambda function but are <strong>not</strong> added to the agent's prompt. As a result, you can only use session attributes if your lambda function can handle them. You can find more examples of using a session attribute <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/agents-for-bedrock/features-examples/06-prompt-and-session-attributes>here</a>. It is also a good pattern to implement fine-grained access control for certain APIs using the lambda function integration. You can find an example for it <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/agents-for-bedrock/features-examples/09-fine-grained-access-permissions>here</a> - <strong><code>promptSessionAttributes</code></strong>: attributes that persist over a single invokeAgent call. Prompt attributes are added to the prompt and to the lambda function. You can also use the <code>$prompt_session_attributes$</code> placeholder when editing the orchestration base prompt. - <strong><code>invocationId</code></strong>: The id returned by the agent in the <a href=https://docs.aws.amazon.com/bedrock/latest/APIReference/API_agent-runtime_ReturnControlPayload.html>ReturnControlPayload</a> object in the returnControl field of the InvokeAgent response. This field is required if passing the answer of a Return of Control invocation. You can find an example of how to use it <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/agents-for-bedrock/features-examples/03-create-agent-with-return-of-control>here</a>. - <strong><code>returnControlInvocationResults</code></strong>: the results obtained from invoking the action outside of Amazon Bedrock Agents. This field is required if passing the answer of a Return of Control invocation. You can find an example of how to use it <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/agents-for-bedrock/features-examples/03-create-agent-with-return-of-control>here</a>.</p> <p>Finally, if <code>show_code_use</code> is passed as True, the helper will print a message when the code interpreter is invoked. It turns on tracing internally to do this.</p> <p>We will also use the test <code>agent_alias_id</code> set to <code>TSTALIASID</code>. This is a default value that you can use to test agents being developed. You can also <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/agents-deploy.html>deploy your agent</a> to create a new version of your agent and have a new agent alias id.</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>invoke_agent_helper</span><span class=p>(</span>
    <span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>memory_id</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>end_session</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>False</span>
<span class=p>):</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>session_state</span><span class=p>:</span>
        <span class=n>session_state</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=c1># invoke the agent API</span>
    <span class=n>agent_response</span> <span class=o>=</span> <span class=n>bedrock_agent_runtime_client</span><span class=o>.</span><span class=n>invoke_agent</span><span class=p>(</span>
        <span class=n>inputText</span><span class=o>=</span><span class=n>query</span><span class=p>,</span>
        <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span><span class=p>,</span>
        <span class=n>agentAliasId</span><span class=o>=</span><span class=n>alias_id</span><span class=p>,</span>
        <span class=n>sessionId</span><span class=o>=</span><span class=n>session_id</span><span class=p>,</span>
        <span class=n>enableTrace</span><span class=o>=</span><span class=p>(</span><span class=n>enable_trace</span> <span class=o>|</span> <span class=n>show_code_use</span><span class=p>),</span> <span class=c1># Force tracing on if showing code use</span>
        <span class=n>endSession</span><span class=o>=</span><span class=n>end_session</span><span class=p>,</span>
        <span class=n>memoryId</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span>
        <span class=n>sessionState</span><span class=o>=</span><span class=n>session_state</span>
    <span class=p>)</span>
    <span class=k>return</span> <span class=n>process_response</span><span class=p>(</span><span class=n>agent_response</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=n>enable_trace</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=n>show_code_use</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>process_response</span><span class=p>(</span><span class=n>resp</span><span class=p>,</span> <span class=n>enable_trace</span><span class=p>:</span><span class=nb>bool</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>show_code_use</span><span class=p>:</span><span class=nb>bool</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>enable_trace</span><span class=p>:</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>pprint</span><span class=o>.</span><span class=n>pprint</span><span class=p>(</span><span class=n>resp</span><span class=p>))</span>

    <span class=n>event_stream</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=s1>&#39;completion&#39;</span><span class=p>]</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>event_stream</span><span class=p>:</span>
            <span class=k>if</span> <span class=s1>&#39;chunk&#39;</span> <span class=ow>in</span> <span class=n>event</span><span class=p>:</span>
                <span class=n>data</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;chunk&#39;</span><span class=p>][</span><span class=s1>&#39;bytes&#39;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>enable_trace</span><span class=p>:</span>
                    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Final answer -&gt;</span><span class=se>\n</span><span class=si>{</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
                <span class=n>agent_answer</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
                <span class=k>return</span> <span class=n>agent_answer</span>
                <span class=c1># End event indicates that the request finished successfully</span>
            <span class=k>elif</span> <span class=s1>&#39;trace&#39;</span> <span class=ow>in</span> <span class=n>event</span><span class=p>:</span>
                <span class=k>if</span> <span class=s1>&#39;codeInterpreterInvocationInput&#39;</span> <span class=ow>in</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;trace&#39;</span><span class=p>]):</span>
                    <span class=k>if</span> <span class=n>show_code_use</span><span class=p>:</span>
                        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Invoked code interpreter&quot;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>enable_trace</span><span class=p>:</span>
                    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;trace&#39;</span><span class=p>],</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&quot;unexpected event.&quot;</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&quot;unexpected event.&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</code></pre></div> <h2>Invoking code interpreter</h2> <p>We ask the agent to generate a random string, which will require it to use the code interpreter. Using the <code>show_code_use</code> flag, we can see that the agent invokes code interpreter to evaluate the python code it generates.</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>create</span> <span class=n>a</span> <span class=n>random</span> <span class=nb>id</span> <span class=k>for</span> <span class=n>session</span> <span class=n>initiator</span> <span class=nb>id</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>session_id</span><span class=p>:</span><span class=nb>str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid1</span><span class=p>())</span>
<span class=n>memory_id</span><span class=p>:</span><span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;TST_MEM_ID&#39;</span>
<span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;Please generate a 10 character long string of random characters&quot;</span>
<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <p>Similarly, the agent will write Python code and invoke code interpreter to solve math problems</p> <div class=highlight><pre><span></span><code><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;What is 75 * sin(.75)?&quot;</span>
<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> 
                    <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <p>By comparison, other operations where the model does not need to execute code do not invoke code interpreter</p> <div class=highlight><pre><span></span><code><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;thank you!&quot;</span>
<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h2>Sending files to the agent</h2> <p>We can send files to the agent, either for use in normal chat, or for use with code interpreter. To send files, we attach them to the session state.</p> <h3>Define helper functions</h3> <p>We define helper functions to handle the various kinds of files, setting the media type properly, and to invoke the agent and process responses</p> <p>The helper function below adds files to the session state. Files are passed via the session state. Each file is specified by a: * name * sourceType ('s3', or 'byte_content' for local files, * mediaType (currently supports: CSV, XLS, XLSX, YAML, JSON, DOC, DOCX, HTML, MD, TXT, and PDF) * data (from the file data) * useCase indicating how we intend the model use the file, which can be either <code>CHAT</code> or <code>CODE_INTERPRETER</code>.</p> <p>See the <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/agents-test-code-interpretation.html>session state documentation</a> for more detail.</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Return</span> <span class=n>a</span> <span class=n>session</span> <span class=n>state</span> <span class=n>populated</span> <span class=k>with</span> <span class=n>the</span> <span class=n>files</span> <span class=kn>from</span> <span class=nn>the</span> <span class=n>supplied</span> <span class=nb>list</span> <span class=n>of</span> <span class=n>filenames</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=k>def</span> <span class=nf>add_file_to_session_state</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>use_case</span><span class=o>=</span><span class=s1>&#39;CODE_INTERPRETER&#39;</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>use_case</span> <span class=o>!=</span> <span class=s2>&quot;CHAT&quot;</span> <span class=ow>and</span> <span class=n>use_case</span> <span class=o>!=</span> <span class=s2>&quot;CODE_INTERPRETER&quot;</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Use case must be either &#39;CHAT&#39; or &#39;CODE_INTERPRETER&#39;&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>session_state</span><span class=p>:</span>
        <span class=n>session_state</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;files&quot;</span><span class=p>:</span> <span class=p>[]</span>
        <span class=p>}</span>
    <span class=nb>type</span> <span class=o>=</span> <span class=n>file_name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>file_name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;/&quot;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>

    <span class=k>if</span> <span class=nb>type</span> <span class=o>==</span> <span class=s2>&quot;CSV&quot;</span><span class=p>:</span>
        <span class=n>media_type</span> <span class=o>=</span> <span class=s2>&quot;text/csv&quot;</span> 
    <span class=k>elif</span> <span class=nb>type</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&quot;XLS&quot;</span><span class=p>,</span> <span class=s2>&quot;XLSX&quot;</span><span class=p>]:</span>
        <span class=n>media_type</span> <span class=o>=</span> <span class=s2>&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>media_type</span> <span class=o>=</span> <span class=s2>&quot;text/plain&quot;</span>

    <span class=n>named_file</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span>
        <span class=s2>&quot;source&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>&quot;sourceType&quot;</span><span class=p>:</span> <span class=s2>&quot;BYTE_CONTENT&quot;</span><span class=p>,</span> 
            <span class=s2>&quot;byteContent&quot;</span><span class=p>:</span> <span class=p>{</span>
                <span class=s2>&quot;mediaType&quot;</span><span class=p>:</span> <span class=n>media_type</span><span class=p>,</span>
                <span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=s2>&quot;rb&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
            <span class=p>}</span>
        <span class=p>},</span>
        <span class=s2>&quot;useCase&quot;</span><span class=p>:</span> <span class=n>use_case</span>
    <span class=p>}</span>
    <span class=n>session_state</span><span class=p>[</span><span class=s1>&#39;files&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>named_file</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>session_state</span>
</code></pre></div> <h3>Passing files for normal chat</h3> <p>Here we pass in a local CSV file and ask the model to explain what the data is. Note that when adding the file to the session state, we specify use case 'CHAT' instead of 'CODE_INTERPRETER' and by setting show_code_use=True for our helper we see that the model does not use the code interpreter, it assesses the information using the LLM model's intelligence.</p> <p>First, we examine the file ourselves. We see it is a list of historical prices for a stock.</p> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>base64</span> 

<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>base64</span> <span class=n>encode</span> <span class=n>the</span> <span class=n>csv</span> <span class=n>file</span> <span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>stock_file</span><span class=p>,</span> <span class=s2>&quot;rb&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file_name</span><span class=p>:</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>file_name</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
    <span class=n>encoded_file</span> <span class=o>=</span> <span class=n>data</span> <span class=c1>#base64.b64encode(data)</span>

    <span class=c1># Show the first 100 characters of the encoded file</span>
<span class=n>encoded_file</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>100</span><span class=p>]</span>
</code></pre></div> <p>Next, we invoke the agent to examine the file and tell us about its data. The agent recognizes the data in the file (which contains synthetically generated stock price data for 'FAKECO'), telling us what kind of data it is and what date range it covers. Note that it does not need to invoke code interpretation to do this.</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Invoke</span> <span class=n>the</span> <span class=n>agent</span> <span class=ow>and</span> <span class=n>process</span> <span class=n>the</span> <span class=n>response</span> <span class=n>stream</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;What is the data in this file?&quot;</span>

<span class=n>sessionState</span><span class=o>=</span><span class=n>add_file_to_session_state</span><span class=p>(</span><span class=n>stock_file</span><span class=p>,</span> <span class=s1>&#39;CHAT&#39;</span><span class=p>)</span>

<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=n>sessionState</span><span class=p>,</span> 
                    <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h3>Passing files for use with code interpretation</h3> <p>Now that we know the contents of the file are stock data, we can ask financial questions about it, which will require the model to invoke the code interpreter. Here we re-create the session data specifying the use case as 'CODE_INTERPRETER'</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Invoke</span> <span class=n>the</span> <span class=n>agent</span> <span class=ow>and</span> <span class=n>process</span> <span class=n>the</span> <span class=n>response</span> <span class=n>stream</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;Given the attached price data file, what pct growth happened across the full time series for closing price? what was the price on the first and last days?&quot;</span>

<span class=n>sessionState</span><span class=o>=</span><span class=n>add_file_to_session_state</span><span class=p>(</span><span class=n>stock_file</span><span class=p>,</span> <span class=s1>&#39;CODE_INTERPRETER&#39;</span><span class=p>)</span>

<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=n>sessionState</span><span class=p>,</span> 
                    <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <p>We see the model invoked the code interpreter, and analyzed the data in response to the questions asked.</p> <h2>Generating files with code interpreter</h2> <p>Amazon Bedrock agents can also generate and return files to the user. They can generate files either by using the model's native intelligence to generate file types, such as .CSV files, or by the agent writing code using code interpreter to write code to generate binary files, such as data plots. Agents return files in the response stream.</p> <h3>The Bedrock Agents response stream</h3> <p>The response stream consists of events, formatted in JSON. It conveys rich data about the details of the agent's thought and actions as it works through the <a href=https://aws.amazon.com/blogs/aws/preview-enable-foundation-models-to-complete-tasks-with-agents-for-amazon-bedrock/ >ReAct pattern</a> (reasoning and action). Here are some important keys: * 'files' contain files generated by the agent's LLM model intrinsically * 'trace' events contain information about the agent's thought process and work steps. There are several kinds of trace events: * 'modelInvocationInput' keys contain * 'rationale' keys contain the agent's reasoning * 'invocationInput' keys contain details of parameters to action group calls. * 'codeInterpreterInvocationInput' keys within that contain code that the model generated and is passing to code interpretation. * 'observation' keys contain important observations, including: * 'codeInterpreterInvocationOutput' within that contains specific output from the code interpretation: * 'executionOutput' contains the results of the code execution * 'executionError' is populated with an error if an error is encountered while executing the code * 'files' contain files generated by the code interpretation * 'finalResponse' contains the agent's final response</p> <p>We will redefine our helper function to capture file results from the response stream. Then we will use it to save files generated by the agent, either through its own intelligence or by using code interpretation, and returned to the user.</p> <h3>Redefine the helper function</h3> <p>We redefine the <code>process_response</code> helper function to be able to capture and display more of the rich detail from the response stream. Here we are importing IPython.display so that if run in a notebook with rich display output like Markdown, it can better display the agent interaction, such as embeddng returned files for display. We must import additional libraries for notebook and image handling.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>IPython.display</span> <span class=kn>import</span> <span class=n>display</span><span class=p>,</span> <span class=n>Markdown</span>
<span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
<span class=kn>import</span> <span class=nn>matplotlib.image</span> <span class=k>as</span> <span class=nn>mpimg</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>process_response</span><span class=p>(</span><span class=n>resp</span><span class=p>,</span> <span class=n>enable_trace</span><span class=p>:</span><span class=nb>bool</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>show_code_use</span><span class=p>:</span><span class=nb>bool</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>resp</span><span class=p>[</span><span class=s1>&#39;ResponseMetadata&#39;</span><span class=p>][</span><span class=s1>&#39;HTTPStatusCode&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;API Response was not 200: </span><span class=si>{</span><span class=n>resp</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

    <span class=n>event_stream</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=s1>&#39;completion&#39;</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>event_stream</span><span class=p>:</span>
        <span class=k>if</span> <span class=s1>&#39;files&#39;</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
            <span class=n>files_event</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;files&#39;</span><span class=p>]</span>
            <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=s2>&quot;### Files&quot;</span><span class=p>))</span>
            <span class=n>files_list</span> <span class=o>=</span> <span class=n>files_event</span><span class=p>[</span><span class=s1>&#39;files&#39;</span><span class=p>]</span>
            <span class=k>for</span> <span class=n>this_file</span> <span class=ow>in</span> <span class=n>files_list</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
                <span class=n>file_bytes</span> <span class=o>=</span> <span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;bytes&#39;</span><span class=p>]</span>

                <span class=c1># save bytes to file, given the name of file and the bytes </span>
                <span class=n>file_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>,</span> <span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>])</span>
                <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>file_bytes</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;image/png&#39;</span> <span class=ow>or</span> <span class=n>this_file</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>:</span>
                    <span class=n>img</span> <span class=o>=</span> <span class=n>mpimg</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>file_name</span><span class=p>)</span>
                    <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
                    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>

        <span class=k>if</span> <span class=s1>&#39;trace&#39;</span> <span class=ow>in</span> <span class=n>event</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span> <span class=ow>and</span> <span class=n>enable_trace</span><span class=p>:</span>
            <span class=n>trace_event</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;trace&#39;</span><span class=p>)[</span><span class=s1>&#39;trace&#39;</span><span class=p>][</span><span class=s1>&#39;orchestrationTrace&#39;</span><span class=p>]</span>

            <span class=k>if</span> <span class=s1>&#39;modelInvocationInput&#39;</span> <span class=ow>in</span> <span class=n>trace_event</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=k>pass</span>

            <span class=k>if</span> <span class=s1>&#39;rationale&#39;</span> <span class=ow>in</span> <span class=n>trace_event</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=n>rationale</span> <span class=o>=</span> <span class=n>trace_event</span><span class=p>[</span><span class=s1>&#39;rationale&#39;</span><span class=p>][</span><span class=s1>&#39;text&#39;</span><span class=p>]</span>
                <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;### Rationale</span><span class=se>\n</span><span class=si>{</span><span class=n>rationale</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>

            <span class=k>if</span> <span class=s1>&#39;invocationInput&#39;</span> <span class=ow>in</span> <span class=n>trace_event</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span> <span class=ow>and</span> <span class=n>show_code_use</span><span class=p>:</span>
                <span class=n>inv_input</span> <span class=o>=</span> <span class=n>trace_event</span><span class=p>[</span><span class=s1>&#39;invocationInput&#39;</span><span class=p>]</span>
                <span class=k>if</span> <span class=s1>&#39;codeInterpreterInvocationInput&#39;</span> <span class=ow>in</span> <span class=n>inv_input</span><span class=p>:</span>
                    <span class=n>gen_code</span> <span class=o>=</span> <span class=n>inv_input</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationInput&#39;</span><span class=p>][</span><span class=s1>&#39;code&#39;</span><span class=p>]</span>
                    <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;```python</span><span class=se>\n</span><span class=si>{</span><span class=n>gen_code</span><span class=si>}</span><span class=se>\n</span><span class=s2>```&quot;</span>
                    <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;### Generated code</span><span class=se>\n</span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>

            <span class=k>if</span> <span class=s1>&#39;observation&#39;</span> <span class=ow>in</span> <span class=n>trace_event</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=n>obs</span> <span class=o>=</span> <span class=n>trace_event</span><span class=p>[</span><span class=s1>&#39;observation&#39;</span><span class=p>]</span>
                <span class=k>if</span> <span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span> <span class=ow>in</span> <span class=n>obs</span><span class=p>:</span>
                    <span class=k>if</span> <span class=s1>&#39;executionOutput&#39;</span> <span class=ow>in</span> <span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span> <span class=ow>and</span> <span class=n>show_code_use</span><span class=p>:</span>
                        <span class=n>raw_output</span> <span class=o>=</span> <span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>][</span><span class=s1>&#39;executionOutput&#39;</span><span class=p>]</span>
                        <span class=n>output</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;```</span><span class=se>\n</span><span class=si>{</span><span class=n>raw_output</span><span class=si>}</span><span class=se>\n</span><span class=s2>```&quot;</span>
                        <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;### Output from code execution</span><span class=se>\n</span><span class=si>{</span><span class=n>output</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>

                    <span class=k>if</span> <span class=s1>&#39;executionError&#39;</span> <span class=ow>in</span> <span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;### Error from code execution</span><span class=se>\n</span><span class=si>{</span><span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>][</span><span class=s1>&#39;executionError&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>

                    <span class=k>if</span> <span class=s1>&#39;files&#39;</span> <span class=ow>in</span> <span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=s2>&quot;### Files generated</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>))</span>
                        <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>obs</span><span class=p>[</span><span class=s1>&#39;codeInterpreterInvocationOutput&#39;</span><span class=p>][</span><span class=s1>&#39;files&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>

                <span class=k>if</span> <span class=s1>&#39;finalResponse&#39;</span> <span class=ow>in</span> <span class=n>obs</span><span class=p>:</span>                    
                    <span class=n>final_resp</span> <span class=o>=</span> <span class=n>obs</span><span class=p>[</span><span class=s1>&#39;finalResponse&#39;</span><span class=p>][</span><span class=s1>&#39;text&#39;</span><span class=p>]</span>
                    <span class=n>display</span><span class=p>(</span><span class=n>Markdown</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;### Final response</span><span class=se>\n</span><span class=si>{</span><span class=n>final_resp</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>))</span>
                    <span class=k>return</span> <span class=n>final_resp</span>
</code></pre></div> <h3>Generate a file using code generation</h3> <p>We will ask the agent to generate a file, which it will return via the response stream.</p> <div class=highlight><pre><span></span><code><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>Please generate a list of the 10 greatest books of all time. Return it as a CSV file. Always return the file, even if you have provided it before.</span>
<span class=s2>&quot;&quot;&quot;</span>

<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=n>sessionState</span><span class=p>,</span>
                    <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h3>Generate a chart using code interpretation</h3> <p>We will send in the same stock price data file as before, but this time will ask for a chart. Our agent will need to write python code to create the chart. The markdown-enhanced response stream parser will render the chart into the notebook.</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Invoke</span> <span class=n>the</span> <span class=n>agent</span> <span class=ow>and</span> <span class=n>process</span> <span class=n>the</span> <span class=n>response</span> <span class=n>stream</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;Given the attached price data file, please make me a chart with moving average in red and actual data in blue&quot;</span>

<span class=n>sessionState</span><span class=o>=</span><span class=n>add_file_to_session_state</span><span class=p>(</span><span class=n>stock_file</span><span class=p>,</span> <span class=s1>&#39;CODE_INTERPRETER&#39;</span><span class=p>)</span>

<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=n>sessionState</span><span class=p>,</span>
                    <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h3>Generate synthetic data and analyze it</h3> <p>For a final more complex example, we prompt the agent to create a synthetic data set, perform analysis, and render a visualization</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Invoke</span> <span class=n>the</span> <span class=n>agent</span> <span class=ow>and</span> <span class=n>process</span> <span class=n>the</span> <span class=n>response</span> <span class=n>stream</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>generate two csv files for me. </span>
<span class=s2>one called SALES, with 3 columns: COMPANY_ID, COMPANY_NAME, and SALES_2024. </span>
<span class=s2>the other called DETAILS, with 3 columns: COMPANY_ID, COMPANY_STATE_CODE. </span>
<span class=s2>follow these rules:</span>
<span class=s2>1) each file should contain 200 companies, and share the same company ID’s. </span>
<span class=s2>2) use human readable english words in the names (not random strings of letters and digits), </span>
<span class=s2>3) use ID’s of the form: C00001. </span>
<span class=s2>4) Only use states that are generally considered to be near the east coast or near the west coast. </span>
<span class=s2>5) Make the revenue from each eastern company range from 0 to $700,000, </span>
<span class=s2>6) Make revenue from each western company range from $500,000 up to $2,000,000. </span>
<span class=s2>When done, test to be sure you have followed each of the above rules, </span>
<span class=s2>and produce a chart comparing sales per company in the two regions using box plots.</span>
<span class=s2>&quot;&quot;&quot;</span>

<span class=n>invoke_agent_helper</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>agent_id</span><span class=p>,</span> <span class=n>agent_alias_id</span><span class=p>,</span> <span class=n>enable_trace</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>session_state</span><span class=o>=</span><span class=n>sessionState</span><span class=p>,</span>
                    <span class=n>memory_id</span><span class=o>=</span><span class=n>memory_id</span><span class=p>,</span> <span class=n>show_code_use</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div> <h2>Clean up</h2> <p>Optionally, you can clean up the resources created</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>This</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>needed</span><span class=p>,</span> <span class=n>you</span> <span class=n>can</span> <span class=n>delete</span> <span class=n>agent</span> <span class=n>successfully</span> <span class=n>after</span> <span class=n>deleting</span> <span class=n>alias</span> <span class=n>only</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Additionaly</span><span class=p>,</span> <span class=n>you</span> <span class=n>need</span> <span class=n>to</span> <span class=n>disable</span> <span class=n>it</span> <span class=n>first</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>
<span class=n>action_group_id</span> <span class=o>=</span> <span class=n>agent_action_group_response</span><span class=p>[</span><span class=s1>&#39;agentActionGroup&#39;</span><span class=p>][</span><span class=s1>&#39;actionGroupId&#39;</span><span class=p>]</span>
<span class=n>action_group_name</span> <span class=o>=</span> <span class=n>agent_action_group_response</span><span class=p>[</span><span class=s1>&#39;agentActionGroup&#39;</span><span class=p>][</span><span class=s1>&#39;actionGroupName&#39;</span><span class=p>]</span>

<span class=n>response</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>update_agent_action_group</span><span class=p>(</span>
    <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span><span class=p>,</span>
    <span class=n>agentVersion</span><span class=o>=</span><span class=s1>&#39;DRAFT&#39;</span><span class=p>,</span>
    <span class=n>actionGroupId</span><span class=o>=</span> <span class=n>action_group_id</span><span class=p>,</span>
    <span class=n>actionGroupName</span><span class=o>=</span><span class=n>action_group_name</span><span class=p>,</span>
    <span class=n>actionGroupState</span><span class=o>=</span><span class=s1>&#39;DISABLED&#39;</span><span class=p>,</span>
    <span class=n>parentActionGroupSignature</span><span class=o>=</span><span class=s1>&#39;AMAZON.CodeInterpreter&#39;</span>
<span class=p>)</span>

<span class=n>action_group_deletion</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>delete_agent_action_group</span><span class=p>(</span>
    <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span><span class=p>,</span>
    <span class=n>agentVersion</span><span class=o>=</span><span class=s1>&#39;DRAFT&#39;</span><span class=p>,</span>
    <span class=n>actionGroupId</span><span class=o>=</span> <span class=n>action_group_id</span>
<span class=p>)</span>
<span class=n>agent_deletion</span> <span class=o>=</span> <span class=n>bedrock_agent_client</span><span class=o>.</span><span class=n>delete_agent</span><span class=p>(</span>
    <span class=n>agentId</span><span class=o>=</span><span class=n>agent_id</span>
<span class=p>)</span>

<span class=o>&lt;</span><span class=n>h2</span><span class=o>&gt;</span><span class=n>Delete</span> <span class=n>IAM</span> <span class=n>Roles</span> <span class=ow>and</span> <span class=n>policies</span><span class=o>&lt;/</span><span class=n>h2</span><span class=o>&gt;</span>

<span class=k>for</span> <span class=n>policy</span> <span class=ow>in</span> <span class=p>[</span><span class=n>agent_bedrock_allow_policy_name</span><span class=p>]:</span>
    <span class=n>iam_client</span><span class=o>.</span><span class=n>detach_role_policy</span><span class=p>(</span><span class=n>RoleName</span><span class=o>=</span><span class=n>agent_role_name</span><span class=p>,</span> <span class=n>PolicyArn</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;arn:aws:iam::</span><span class=si>{</span><span class=n>account_id</span><span class=si>}</span><span class=s1>:policy/</span><span class=si>{</span><span class=n>policy</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=k>for</span> <span class=n>policy</span> <span class=ow>in</span> <span class=p>[</span><span class=n>agent_bedrock_policy</span><span class=p>]:</span>
    <span class=n>iam_client</span><span class=o>.</span><span class=n>delete_policy</span><span class=p>(</span>
        <span class=n>PolicyArn</span><span class=o>=</span><span class=n>policy</span><span class=p>[</span><span class=s1>&#39;Policy&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
<span class=p>)</span>

<span class=n>iam_client</span><span class=o>.</span><span class=n>delete_role</span><span class=p>(</span>
    <span class=n>RoleName</span><span class=o>=</span><span class=n>agent_role_name</span>
<span class=p>)</span>
</code></pre></div> <h2>Conclusion</h2> <p>We have now experimented with using boto3 SDK to create and invoke an agent with code interpretation enabled. We also learned how send files to the agent and to retrieve files returned by the agent in its response stream. We used Markdown rendering to better display the elements that the agent transmits in its response stream, including its rationale, code that it writes to pursue the goal, and the results from code invocation.</p> <h2>Next Steps</h2> <p>As a next step, you should experiment further with the the agent's to explore how it can to pursue more complex requests using code evaluation. </p> <h2>Thank You</h2> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by <a href="https://github.com/aws-samples/amazon-bedrock-samples/issues/new?title=[Online Feedback]: Short-Summary-of-Issue&body=Page URL: /agents-and-function-calling/bedrock-agents/features-examples/10-create-agent-with-code-interpreter/10-create-agent-with-code-interpreter/" target=_blank rel=noopener>creating an issue</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../09-create-agent-with-memory/09-create-agent-with-memory/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Create Agent with Memory"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Create Agent with Memory </div> </div> </a> <a href=../../14-create-agent-with-custom-orchestration/custom_orchestration_example/ class="md-footer__link md-footer__link--next" aria-label="Next: Create Agent with Custom Orchestration"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Create Agent with Custom Orchestration </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved. </div> </div> <div class=md-social> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["tags", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "navigation.footer", "search.highlight", "search.suggest"], "search": "../../../../../assets/javascripts/workers/search.6ce7567c.min.js", "tags": {"Compatibility": "compat"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../../../assets/javascripts/bundle.88dd0f4e.min.js></script> <script src=../../../../../javascript/feedback.js></script> </body> </html>