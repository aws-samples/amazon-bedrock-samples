<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Amazon Bedrock cookbook website"><meta name=author content=Bedrock-GTM><link href=https://github.amazon-bedrock-samples.com/introduction-to-bedrock/batch_api/batch-inference-cloudtrail-analyzer/ rel=canonical><link rel=icon href=../../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>Batch inference cloudtrail analyzer - Amazon Bedrock Recipes</title><link rel=stylesheet href=../../../assets/stylesheets/main.6f8fc17f.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Amazon Bedrock Recipes" class="md-header__button md-logo" aria-label="Amazon Bedrock Recipes" data-md-component=logo> <img src=../../../logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Amazon Bedrock Recipes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Batch inference cloudtrail analyzer </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=purple aria-hidden=true type=radio name=__palette id=__palette_0> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Github: Amazon-Bedrock-Samples </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Amazon Bedrock Recipes" class="md-nav__button md-logo" aria-label="Amazon Bedrock Recipes" data-md-component=logo> <img src=../../../logo.png alt=logo> </a> Amazon Bedrock Recipes </label> <div class=md-nav__source> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Github: Amazon-Bedrock-Samples </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> Intro to Amazon Bedrock </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Intro to Amazon Bedrock </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_1> <label class=md-nav__link for=__nav_2_1_1 id=__nav_2_1_1_label tabindex=0> <span class=md-ellipsis> API Usage </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_1> <span class="md-nav__icon md-icon"></span> API Usage </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../bedrock_apis/01_invoke_api/ class=md-nav__link> <span class=md-ellipsis> Invoke Model API Example </span> </a> </li> <li class=md-nav__item> <a href=../../bedrock_apis/04_agents_api/ class=md-nav__link> <span class=md-ellipsis> Agents API Example </span> </a> </li> <li class=md-nav__item> <a href=../../bedrock_apis/03_knowledgebases_api/ class=md-nav__link> <span class=md-ellipsis> Knowledge Bases API Example </span> </a> </li> <li class=md-nav__item> <a href=../../bedrock_apis/02_guardrails_api/ class=md-nav__link> <span class=md-ellipsis> Guardrail API Example </span> </a> </li> <li class=md-nav__item> <a href=../../converse_api/01_converse_api/ class=md-nav__link> <span class=md-ellipsis> Converse API Example </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Agents </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Agents </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1> <label class=md-nav__link for=__nav_2_2_1 id=__nav_2_2_1_label tabindex=0> <span class=md-ellipsis> Amazon Bedrock Agents </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> Amazon Bedrock Agents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/introduction-to-agents/how_to_create_custom_agents/ class=md-nav__link> <span class=md-ellipsis> How to create an Agent </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_2> <label class=md-nav__link for=__nav_2_2_1_2 id=__nav_2_2_1_2_label tabindex=0> <span class=md-ellipsis> Bedrock Agent Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1_2> <span class="md-nav__icon md-icon"></span> Bedrock Agent Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/01-create-agent-with-function-definition/01-create-agent-with-function-definition/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Function Definition </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/02-create-agent-with-api-schema/02-create-agent-with-api-schema/ class=md-nav__link> <span class=md-ellipsis> Create Agent with API Schema </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/03-create-agent-with-return-of-control/03-create-agent-with-return-of-control/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Return of Control </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/04-create-agent-with-single-knowledge-base/04-create-agent-with-single-knowledge-base/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Single Knowledge Base </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/05-create-agent-with-knowledge-base-and-action-group/05-create-agent-with-knowledge-base-and-action-group/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Knowledge Base and Action Group </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/06-prompt-and-session-attributes/06-prompt-and-session-attributes/ class=md-nav__link> <span class=md-ellipsis> Prompt and Session Attributes </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/07-advanced-prompts-and-custom-parsers/07-custom-prompt-and-lambda-parsers/ class=md-nav__link> <span class=md-ellipsis> Custom Prompt and Lambda Parsers </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/08-create-agent-with-guardrails/08-create-agent-with-guardrails/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Guardrails </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/09-create-agent-with-memory/09-create-agent-with-memory/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Memory </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/10-create-agent-with-code-interpreter/10-create-agent-with-code-interpreter/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Code Interpreter </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/14-create-agent-with-custom-orchestration/custom_orchestration_example/ class=md-nav__link> <span class=md-ellipsis> Create Agent with Custom Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/features-examples/15-invoke-inline-agents/inline-agent-api-usage/ class=md-nav__link> <span class=md-ellipsis> Create Dynamic Tooling Inline Agents </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_3> <label class=md-nav__link for=__nav_2_2_1_3 id=__nav_2_2_1_3_label tabindex=0> <span class=md-ellipsis> Bedrock Flows </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1_3> <span class="md-nav__icon md-icon"></span> Bedrock Flows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/bedrock-flows/Getting_started_with_Prompt_Management_Flows/ class=md-nav__link> <span class=md-ellipsis> Getting Started with Prompt Management Flows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_1_4> <label class=md-nav__link for=__nav_2_2_1_4 id=__nav_2_2_1_4_label tabindex=0> <span class=md-ellipsis> Use Case Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_1_4> <span class="md-nav__icon md-icon"></span> Use Case Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/use-case-examples/text-2-sql-agent/create_and_invoke_sql_agent/ class=md-nav__link> <span class=md-ellipsis> Text to SQL Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/use-case-examples/agentsforbedrock-retailagent/workshop/test_retailagent_agentsforbedrock/ class=md-nav__link> <span class=md-ellipsis> Retail Agent Workshop </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/bedrock-agents/use-case-examples/product-review-agent/main/ class=md-nav__link> <span class=md-ellipsis> Product Review Agent </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> <span class=md-ellipsis> Function Calling </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> Function Calling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/function-calling/function_calling_with_converse/function_calling_with_converse/ class=md-nav__link> <span class=md-ellipsis> Function Calling with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/function-calling/function_calling_with_invoke/function_calling_model_with_invoke/ class=md-nav__link> <span class=md-ellipsis> Function Calling with Invoke </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/function-calling/return_of_control/return_of_control/ class=md-nav__link> <span class=md-ellipsis> Return of Control </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/function-calling/tool_binding/tool_bindings/ class=md-nav__link> <span class=md-ellipsis> Tool Binding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3> <label class=md-nav__link for=__nav_2_2_3 id=__nav_2_2_3_label tabindex=0> <span class=md-ellipsis> Open Source </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> Open Source </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_1> <label class=md-nav__link for=__nav_2_2_3_1 id=__nav_2_2_3_1_label tabindex=0> <span class=md-ellipsis> CrewAI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_1> <span class="md-nav__icon md-icon"></span> CrewAI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/crew.ai/Find%20dream%20destination%20with%20CrewAI/ class=md-nav__link> <span class=md-ellipsis> Find Dream Destination with CrewAI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_2> <label class=md-nav__link for=__nav_2_2_3_2 id=__nav_2_2_3_2_label tabindex=0> <span class=md-ellipsis> LangGraph </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_2> <span class="md-nav__icon md-icon"></span> LangGraph </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/langgraph-single-agent/ class=md-nav__link> <span class=md-ellipsis> LangGraph Agent with Function Calling </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/langgraph-agents-multimodal/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi-Modal Agent with Function Calling </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/langgraph-multi-agent-sql-tools/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/02_medibot_V3_agents/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent For Medical Chatbot </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/langgraph-fact-checker-feedback-loop/ class=md-nav__link> <span class=md-ellipsis> LangGraph Fact Checker with Multi Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/langgraph-multi-agent-sql-tools/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent Orchestration </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/03_langgraph_agents_of_agent/ class=md-nav__link> <span class=md-ellipsis> LangGraph Multi Agent with tools </span> </a> </li> <li class=md-nav__item> <a href=../../../agents-and-function-calling/open-source-agents/langgraph/Travel_planner_with_langgraph/ class=md-nav__link> <span class=md-ellipsis> Managing Memory for Multi Agents </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3_3> <label class=md-nav__link for=__nav_2_2_3_3 id=__nav_2_2_3_3_label tabindex=0> <span class=md-ellipsis> Multi Agent </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_2_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3_3> <span class="md-nav__icon md-icon"></span> Multi Agent </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../agents-and-function-calling/introduction-to-agents/how_to_create_multi_agents_from_custom_agents/ class=md-nav__link> <span class=md-ellipsis> Multi Agent Orchestration </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> RAG </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> RAG </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1> <label class=md-nav__link for=__nav_2_3_1 id=__nav_2_3_1_label tabindex=0> <span class=md-ellipsis> Amazon Bedrock Knowledge Bases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1> <span class="md-nav__icon md-icon"></span> Amazon Bedrock Knowledge Bases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_1> <label class=md-nav__link for=__nav_2_3_1_1 id=__nav_2_3_1_1_label tabindex=0> <span class=md-ellipsis> Zero Setup </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_1> <span class="md-nav__icon md-icon"></span> Zero Setup </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/00-zero-setup-chat-with-your-document/chat_with_document_kb/ class=md-nav__link> <span class=md-ellipsis> Chat with Your Document </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_2> <label class=md-nav__link for=__nav_2_3_1_2 id=__nav_2_3_1_2_label tabindex=0> <span class=md-ellipsis> RAG Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_2> <span class="md-nav__icon md-icon"></span> RAG Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/01-rag-concepts/01_create_ingest_documents_test_kb_multi_ds/ class=md-nav__link> <span class=md-ellipsis> Create and Ingest Documents with Multi-Data Sources </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/01-rag-concepts/02_managed_rag_custom_prompting_and_no_of_results/ class=md-nav__link> <span class=md-ellipsis> Managed RAG with Custom Prompting </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/01-rag-concepts/03_customized-rag-retreive-api-hybrid-search-claude-3-sonnet-langchain/ class=md-nav__link> <span class=md-ellipsis> Customized RAG with Claude 3 and Langchain </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/01-rag-concepts/04_customized-rag-retreive-api-langchain-claude-evaluation-ragas/ class=md-nav__link> <span class=md-ellipsis> RAG Evaluation with Langchain and RAGAS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_3> <label class=md-nav__link for=__nav_2_3_1_3 id=__nav_2_3_1_3_label tabindex=0> <span class=md-ellipsis> Optimizing Retrieval Results </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_3> <span class="md-nav__icon md-icon"></span> Optimizing Retrieval Results </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/advanced_chunking_options/ class=md-nav__link> <span class=md-ellipsis> Advanced Chunking Options </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/csv_metadata_customization/ class=md-nav__link> <span class=md-ellipsis> CSV Metadata Customization </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/query_reformulation/ class=md-nav__link> <span class=md-ellipsis> Query Reformulation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_4> <label class=md-nav__link for=__nav_2_3_1_4 id=__nav_2_3_1_4_label tabindex=0> <span class=md-ellipsis> Advanced Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_4> <span class="md-nav__icon md-icon"></span> Advanced Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/03-advanced-concepts/dynamic-metadata-filtering/dynamic-metadata-filtering-KB/ class=md-nav__link> <span class=md-ellipsis> Dynamic Metadata Filtering </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_4_2> <label class=md-nav__link for=__nav_2_3_1_4_2 id=__nav_2_3_1_4_2_label tabindex=0> <span class=md-ellipsis> Reranking </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_4_2> <span class="md-nav__icon md-icon"></span> Reranking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/01_deploy-reranking-model-sm/ class=md-nav__link> <span class=md-ellipsis> Deploy Reranking Model </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/02_kb-reranker/ class=md-nav__link> <span class=md-ellipsis> Knowledge Base Reranker </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/03-advanced-concepts/reranking/qa-generator/ class=md-nav__link> <span class=md-ellipsis> QA Generator </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_5> <label class=md-nav__link for=__nav_2_3_1_5 id=__nav_2_3_1_5_label tabindex=0> <span class=md-ellipsis> Responsible AI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_5> <span class="md-nav__icon md-icon"></span> Responsible AI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/features-examples/05-responsible-ai/contextual-grounding/ class=md-nav__link> <span class=md-ellipsis> Contextual Grounding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6> <label class=md-nav__link for=__nav_2_3_1_6 id=__nav_2_3_1_6_label tabindex=0> <span class=md-ellipsis> Use Case Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6> <span class="md-nav__icon md-icon"></span> Use Case Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6_1> <label class=md-nav__link for=__nav_2_3_1_6_1 id=__nav_2_3_1_6_1_label tabindex=0> <span class=md-ellipsis> Metadata Filter Access Control </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_6_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6_1> <span class="md-nav__icon md-icon"></span> Metadata Filter Access Control </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/use-case-examples/metadata-filter-access-control/kb-end-to-end-acl/ class=md-nav__link> <span class=md-ellipsis> End-to-End ACL with Knowledge Base </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_1_6_2> <label class=md-nav__link for=__nav_2_3_1_6_2 id=__nav_2_3_1_6_2_label tabindex=0> <span class=md-ellipsis> RAG with Structured and Unstructured Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_2_3_1_6_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_1_6_2> <span class="md-nav__icon md-icon"></span> RAG with Structured and Unstructured Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/0-create-dummy-structured-data/ class=md-nav__link> <span class=md-ellipsis> Create Dummy Structured Data </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/1_create_sql_dataset_optional/ class=md-nav__link> <span class=md-ellipsis> Create SQL Dataset (Optional) </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/knowledge-bases/use-case-examples/rag-using-structured-unstructured-data/2_rag_with_structured_unstructured_data/ class=md-nav__link> <span class=md-ellipsis> RAG with Structured and Unstructured Data </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2> <label class=md-nav__link for=__nav_2_3_2 id=__nav_2_3_2_label tabindex=0> <span class=md-ellipsis> Open Source </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_2> <span class="md-nav__icon md-icon"></span> Open Source </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/open-source/chatbots/qa_chatbot_langchain_bedrock/ class=md-nav__link> <span class=md-ellipsis> Chatbot using Langchain </span> </a> </li> <li class=md-nav__item> <a href=../../../rag/open-source/chunking/rag_chunking_strategies_langchain_bedrock/ class=md-nav__link> <span class=md-ellipsis> Chunking strategies for RAG applications </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2_3> <label class=md-nav__link for=__nav_2_3_2_3 id=__nav_2_3_2_3_label tabindex=0> <span class=md-ellipsis> Vector Stores </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_2_3> <span class="md-nav__icon md-icon"></span> Vector Stores </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../rag/open-source/vector_stores/rag_langchain_bedrock_opensearch/ class=md-nav__link> <span class=md-ellipsis> Langchain Chatbot with Opensearch </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> Model Customization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Model Customization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../custom-models/model-distillation/Historical_invocation_distillation/ class=md-nav__link> <span class=md-ellipsis> Model Distillation with Invocation Logs </span> </a> </li> <li class=md-nav__item> <a href=../../../custom-models/model-distillation/Distillation-via-S3-input/ class=md-nav__link> <span class=md-ellipsis> Model Distillation with S3 Data </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Gen AI Usecases </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Gen AI Usecases </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Text Generation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Text Generation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../genai-use-cases/text-generation/how_to_work_with_text_generation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Streaming Response with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../genai-use-cases/text-generation/how_to_work_with_code_generation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Generate Python Code with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../genai-use-cases/text-generation/how_to_work_with_text_translation_w_bedrock/ class=md-nav__link> <span class=md-ellipsis> Text Translation with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../genai-use-cases/text-generation/how_to_work_with_text-summarization-titan%2Bclaude/ class=md-nav__link> <span class=md-ellipsis> Text summarization with Converse </span> </a> </li> <li class=md-nav__item> <a href=../../../genai-use-cases/text-generation/how_to_work_with_batch_example_for_multi_threaded_invocation/ class=md-nav__link> <span class=md-ellipsis> Generate Bulk Emails with Batch Inference </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Workshops </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Workshops </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> Open-source L400 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Open-source L400 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/01_usecase_introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction to the Use Case </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/02_Lab_Find%20a%20Dream%20Destination_RAG%20query/ class=md-nav__link> <span class=md-ellipsis> Advanced RAG for Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/02_travel_planner_with_langgraph/ class=md-nav__link> <span class=md-ellipsis> Conversational Memory in Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/03_travel_agent_with_tools/ class=md-nav__link> <span class=md-ellipsis> Multi-Modal and Types of Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/04_travel_booking_multi_agent/ class=md-nav__link> <span class=md-ellipsis> Multi-Agent Collaboration with Human-in-loop </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/05_dream_destination_with_crewai/ class=md-nav__link> <span class=md-ellipsis> Find Dream Destination with CrewAI </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/06_agent_evaluation_with_ragas/ class=md-nav__link> <span class=md-ellipsis> RAGAs Agents Evaluation </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l400/07_dynamic_tooling_agents/ class=md-nav__link> <span class=md-ellipsis> Dynamic Tool invocation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Open-source L200 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Open-source L200 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../workshop/open-source-l200/02_contextual_text_generation/ class=md-nav__link> <span class=md-ellipsis> Introduction to the Use Case </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l200/03_retrieval_based_text_application/ class=md-nav__link> <span class=md-ellipsis> Retrieval Based Text Generation </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l200/04_retrieval_based_chat_application/ class=md-nav__link> <span class=md-ellipsis> Retrieval Based Chat Application </span> </a> </li> <li class=md-nav__item> <a href=../../../workshop/open-source-l200/05_agent_based_text_generation/ class=md-nav__link> <span class=md-ellipsis> Agent Based Text Generation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../general/tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> <li class=md-nav__item> <a href=../../../general/license/ class=md-nav__link> <span class=md-ellipsis> License </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../general/tags/#batch-inference class="md-tag md-tag-icon">Batch-Inference</a> <a href=../../../general/tags/#securitycloudtrail class="md-tag md-tag-icon">Security/CloudTrail</a> <a href=../../../general/tags/#api-usage-example class="md-tag md-tag-icon">API-Usage-Example</a> </nav> <!-- <h1>Batch Inference for CloudTrail Analyzer</h1> --> <div class="admonition tip inline end"> <p class=admonition-title><a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main/introduction-to-bedrock/batch_api/batch-inference-cloudtrail-analyzer.ipynb target=_blank>Open in github</a></p> </div> <h2>Overview</h2> <p>This notebook demonstrates how to analyze CloudTrail logs using <b>Amazon Bedrock for batch inference</b> to identify potential security anomalies. </p> <h2>Context</h2> <p>The key steps in this process are:</p> <ol> <li>Data Collection: Retrieve the latest CloudTrail events (default: 20k events)</li> <li>Batch Inference: Use Amazon Bedrock batch inference to analyze user activities in batches.</li> <li>Summarization: Summarize the results to provide a concise overview of potential security concerns in your AWS environment.</li> </ol> <p>The output can be sent to an SNS topic to receive the summary in email for eg.</p> <ul> <li>Amazon Bedrock batch inference works with jsonl files. Each completion to process is a json object with a modelInput and modelOutput.</li> <li>The minimum number of items in the jsonl file for the batch inference job is 1000.</li> <li>Observed time to summarize 2000 batch items of 10 cloudtrail events with given prompt is ~15 minutes.</li> <li>You can check the job status with get_model_invocation_job passing jobArn as parameter.</li> <li>Final summarisation is performed with Amazon Bedrock invoke_model API.</li> </ul> <p>Model chosen for this example is <b>Claude 3 Haiku</b>. This provides a good balance between cost, quality and context size.<br> Other models (Mistal for eg.) can be used as well to lower the cost but would require more requests to be processed due to the smaller context window.</p> <p>Pricing: - Est. Pricing - Input: 20K events est. <b><span class=arithmatex>\(3.3&lt;/b&gt; with Claude 3 Haiku in us-east-1 as of september 2024 - Est. Pricing - Output: 2000 summarizations est. &lt;b&gt;\)</span>1.25</b> with Claude 3 Haiku in us-east-1 as of september 2024</p> <p>Assuming: - 20K events ~600 tokens per event - 10 cloudtrail event per batch item - 500 tokens for prompt size - 15-20 final summarizations of 10k tokens - Input tokens ~13M tokens / est. - 500 tokens per summarization - 2000 summaries to generate in batch inference - 15-20 final summarizations to generate - Output ~1M tokens </p> <h2>Prerequisites</h2> <ul> <li>Make sure boto3 can access your AWS account</li> <li>Make sure you have acces to Claude 3 Haiku model in us-east-1</li> <li>Make sure your credentials allow creation of resources (S3 bucket, SNS topic, IAM role) and access to Bedrock</li> </ul> <div class=highlight><pre><span></span><code><span class=o>%</span><span class=n>pip</span> <span class=n>install</span> <span class=n>boto3</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>json</span>
<span class=kn>import</span> <span class=nn>uuid</span>
<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
<span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>import</span> <span class=nn>utils</span>
<span class=kn>import</span> <span class=nn>bedrock</span>
<span class=kn>from</span> <span class=nn>botocore.exceptions</span> <span class=kn>import</span> <span class=n>ClientError</span>

<span class=n>aws_region</span> <span class=o>=</span> <span class=s2>&quot;us-east-1&quot;</span>

<span class=n>s3</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;s3&#39;</span><span class=p>)</span>
<span class=n>cloudtrail</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;cloudtrail&#39;</span><span class=p>)</span>
<span class=n>sns</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;sns&#39;</span><span class=p>)</span>
<span class=n>iam</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iam&#39;</span><span class=p>)</span>
<span class=n>aws_account_number</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;sts&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>get_caller_identity</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Account&#39;</span><span class=p>)</span>
<span class=n>bedrock</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;bedrock&#39;</span><span class=p>)</span>
<span class=n>bedrock_runtime</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&quot;bedrock-runtime&quot;</span><span class=p>,</span> <span class=n>region_name</span><span class=o>=</span><span class=n>aws_region</span><span class=p>)</span>

<span class=n>batch_inference_input_file</span> <span class=o>=</span> <span class=s2>&quot;input.jsonl&quot;</span>
<span class=n>s3_bucket_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;cloudtrail-analysis-with-bedrock-</span><span class=si>{</span><span class=n>aws_account_number</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=n>bedrock_role_name</span> <span class=o>=</span> <span class=s2>&quot;CloudTrailAnalyser_BedrockS3AccessRole&quot;</span>
<span class=n>sns_topic_name</span> <span class=o>=</span> <span class=s2>&quot;cloudtrail-summary&quot;</span>

<span class=n>s3_input_uri</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;s3://</span><span class=si>{</span><span class=n>s3_bucket_name</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>batch_inference_input_file</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=n>s3_output_uri</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;s3://</span><span class=si>{</span><span class=n>s3_bucket_name</span><span class=si>}</span><span class=s2>/batch_inference_output/&quot;</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># Claude 3 Haiku for a balance between cost and quality</span>
<span class=n>model_id</span> <span class=o>=</span> <span class=s2>&quot;anthropic.claude-3-haiku-20240307-v1:0&quot;</span>

<span class=c1># chars, not tokens. Adjust this to match your model&#39;s context length / performance requirements</span>
<span class=n>max_context_length</span> <span class=o>=</span> <span class=mi>50000</span> 
<span class=c1># chars, not tokens. Size of prompt to summarize the events</span>
<span class=n>prompt_length</span> <span class=o>=</span> <span class=mi>500</span> 
<span class=c1># minimum batch entries in jsonl file required for Amazon Bedrockbatch inference</span>
<span class=n>min_batch_items_for_bedrock_batch_inference</span> <span class=o>=</span> <span class=mi>1000</span> 
<span class=c1># mini batches to keep a balance between summarizing and not losing too much signal</span>
<span class=n>events_per_batch_item</span> <span class=o>=</span> <span class=mi>10</span> 
<span class=c1># max number of batch item entries in the jsonl file, this is a cost control safety measure</span>
<span class=n>max_batch_items</span> <span class=o>=</span> <span class=mi>2000</span>
<span class=c1># max tokens in summary to keep a balance between summarizing and not losing too much signal</span>
<span class=n>max_tokens_in_summary</span> <span class=o>=</span> <span class=mi>500</span>
</code></pre></div> <h2>Setup</h2> <h3> Create S3 bucket, Role, SNS topic</h3> <ul> <li>S3 bucket is needed to store intermediate data for the batch inference job.</li> <li>Role is needed to allow bedrock to access the S3 bucket.</li> <li>SNS topic is needed to receive the final summary.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>create_or_get_bedrock_s3_access_role</span><span class=p>(</span><span class=n>bedrock_role_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>s3_bucket_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>iam</span><span class=o>.</span><span class=n>get_role</span><span class=p>(</span><span class=n>RoleName</span><span class=o>=</span><span class=n>bedrock_role_name</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Role </span><span class=si>{</span><span class=n>bedrock_role_name</span><span class=si>}</span><span class=s2> already exists.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Role&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
    <span class=k>except</span> <span class=n>iam</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>NoSuchEntityException</span><span class=p>:</span>
        <span class=c1># Role doesn&#39;t exist, create it</span>
        <span class=n>trust_policy</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=s2>&quot;2012-10-17&quot;</span><span class=p>,</span>
            <span class=s2>&quot;Statement&quot;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=s2>&quot;Effect&quot;</span><span class=p>:</span> <span class=s2>&quot;Allow&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;Principal&quot;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=s2>&quot;Service&quot;</span><span class=p>:</span> <span class=s2>&quot;bedrock.amazonaws.com&quot;</span>
                    <span class=p>},</span>
                    <span class=s2>&quot;Action&quot;</span><span class=p>:</span> <span class=s2>&quot;sts:AssumeRole&quot;</span>
                <span class=p>}</span>
            <span class=p>]</span>
        <span class=p>}</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>response</span> <span class=o>=</span> <span class=n>iam</span><span class=o>.</span><span class=n>create_role</span><span class=p>(</span>
                <span class=n>RoleName</span><span class=o>=</span><span class=n>bedrock_role_name</span><span class=p>,</span>
                <span class=n>AssumeRolePolicyDocument</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>trust_policy</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=c1># Attach S3 access policy</span>
            <span class=n>s3_policy</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=s2>&quot;2012-10-17&quot;</span><span class=p>,</span>
                <span class=s2>&quot;Statement&quot;</span><span class=p>:</span> <span class=p>[</span>
                    <span class=p>{</span>
                        <span class=s2>&quot;Effect&quot;</span><span class=p>:</span> <span class=s2>&quot;Allow&quot;</span><span class=p>,</span>
                        <span class=s2>&quot;Action&quot;</span><span class=p>:</span> <span class=p>[</span>
                            <span class=s2>&quot;s3:GetObject&quot;</span><span class=p>,</span>
                            <span class=s2>&quot;s3:PutObject&quot;</span><span class=p>,</span>
                            <span class=s2>&quot;s3:ListBucket&quot;</span>
                        <span class=p>],</span>
                        <span class=s2>&quot;Resource&quot;</span><span class=p>:</span> <span class=p>[</span>
                            <span class=sa>f</span><span class=s2>&quot;arn:aws:s3:::</span><span class=si>{</span><span class=n>s3_bucket_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
                            <span class=sa>f</span><span class=s2>&quot;arn:aws:s3:::</span><span class=si>{</span><span class=n>s3_bucket_name</span><span class=si>}</span><span class=s2>/*&quot;</span>
                        <span class=p>]</span>
                    <span class=p>}</span>
                <span class=p>]</span>
            <span class=p>}</span>

            <span class=n>iam</span><span class=o>.</span><span class=n>put_role_policy</span><span class=p>(</span>
                <span class=n>RoleName</span><span class=o>=</span><span class=n>bedrock_role_name</span><span class=p>,</span>
                <span class=n>PolicyName</span><span class=o>=</span><span class=s2>&quot;S3AccessPolicy&quot;</span><span class=p>,</span>
                <span class=n>PolicyDocument</span><span class=o>=</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>s3_policy</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Role </span><span class=si>{</span><span class=n>bedrock_role_name</span><span class=si>}</span><span class=s2> created successfully.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Role&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error creating role: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

<span class=k>def</span> <span class=nf>create_s3_bucket_if_not_exists</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>):</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>s3</span><span class=o>.</span><span class=n>head_bucket</span><span class=p>(</span><span class=n>Bucket</span><span class=o>=</span><span class=n>bucket_name</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Bucket </span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2> already exists.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>True</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>s3</span><span class=o>.</span><span class=n>create_bucket</span><span class=p>(</span><span class=n>Bucket</span><span class=o>=</span><span class=n>bucket_name</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Bucket </span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2> created successfully.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>True</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error creating bucket </span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>False</span>

<span class=k>def</span> <span class=nf>create_or_get_sns_topic</span><span class=p>(</span><span class=n>topic_name</span><span class=p>):</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=c1># create only if it doesnt exist (function is idempotent)</span>
        <span class=n>topic</span> <span class=o>=</span> <span class=n>sns</span><span class=o>.</span><span class=n>create_topic</span><span class=p>(</span><span class=n>Name</span><span class=o>=</span><span class=n>topic_name</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;SNS topic </span><span class=si>{</span><span class=n>topic_name</span><span class=si>}</span><span class=s2> created successfully (arn: </span><span class=si>{</span><span class=n>topic</span><span class=p>[</span><span class=s1>&#39;TopicArn&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>)&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>topic</span><span class=p>[</span><span class=s1>&#39;TopicArn&#39;</span><span class=p>]</span>
    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error creating SNS topic </span><span class=si>{</span><span class=n>topic_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>False</span>

<span class=k>if</span> <span class=ow>not</span> <span class=n>create_s3_bucket_if_not_exists</span><span class=p>(</span><span class=n>s3_bucket_name</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Failed to create or access the S3 bucket.&quot;</span><span class=p>)</span>

<span class=n>role_arn</span> <span class=o>=</span> <span class=n>create_or_get_bedrock_s3_access_role</span><span class=p>(</span><span class=n>bedrock_role_name</span><span class=p>,</span> <span class=n>s3_bucket_name</span><span class=p>)</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>role_arn</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Failed to create or get the IAM role for Bedrock. Exiting.&quot;</span><span class=p>)</span>

<span class=n>sns_topic_arn</span> <span class=o>=</span> <span class=n>create_or_get_sns_topic</span><span class=p>(</span><span class=n>sns_topic_name</span><span class=p>)</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>sns_topic_arn</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Failed to create or get the SNS topic. Exiting.&quot;</span><span class=p>)</span>
</code></pre></div> <h3> Create the batch inference input file</h3> <p>Every line of the input file is a json object with a <code>modelInput</code>.<br> <code>modelInput</code> is the prompt sent to Claude and contains the list of events to summarize.</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>create_batch_entry_and_add_to_file</span><span class=p>(</span><span class=n>events_string</span><span class=p>,</span> <span class=n>input_file</span><span class=p>):</span>

    <span class=c1># putting words in claude&#39;s mouth    </span>
    <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;Human: Please summarize the following list of AWS CloudTrail events for several users. </span>
<span class=s2>    Focus on identifying patterns, unusual activities, and potential security concerns. </span>
<span class=s2>    Here&#39;s the list of events:</span>

<span class=s2>    </span><span class=si>{</span><span class=n>events_string</span><span class=si>}</span>

<span class=s2>    Provide a concise summary of the user&#39;s activities, highlighting any noteworthy or suspicious actions.</span>

<span class=s2>    Assistant: Certainly! I&#39;ll analyze the CloudTrail events several users and provide a summary of their activities, focusing on patterns, unusual activities, and potential security concerns. Here&#39;s the summary:</span>

<span class=s2>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>max_context_length</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Prompt too long: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span><span class=si>}</span><span class=s2> chars for max_context_length configured (chars). </span><span class=se>\</span>
<span class=s2>              Process will carry on anyway. You may encounter errors&quot;</span><span class=p>)</span>

    <span class=n>bedrock_batch_json</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;modelInput&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>&quot;anthropic_version&quot;</span><span class=p>:</span> <span class=s2>&quot;bedrock-2023-05-31&quot;</span><span class=p>,</span> 
            <span class=s2>&quot;max_tokens&quot;</span><span class=p>:</span> <span class=n>max_tokens_in_summary</span><span class=p>,</span>
            <span class=s2>&quot;temperature&quot;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span>
            <span class=s2>&quot;top_p&quot;</span><span class=p>:</span> <span class=mf>0.9</span><span class=p>,</span>
            <span class=s2>&quot;stop_sequences&quot;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s2>&quot;messages&quot;</span><span class=p>:</span> <span class=p>[</span> 
                <span class=p>{</span> 
                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> 
                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=p>[</span>
                        <span class=p>{</span>
                            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;text&quot;</span><span class=p>,</span> 
                            <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>prompt</span> 
                        <span class=p>}</span> 
                    <span class=p>]</span>
                <span class=p>}</span>
            <span class=p>]</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>input_file</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>bedrock_batch_json</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></div> <h3> Process CloudTrail events</h3> <p>Cloudtrail events can be retrieved with the <code>lookup_events</code> API. </p> <p>We paginate through all events in the account and create a jsonl file with a modelInput for each batch item.</p> <p>Max RPS for <code>lookup_events</code> is 2. This can lead to throttling exceptions that are automatically retried by boto3.</p> <div class=highlight><pre><span></span><code><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Starting CloudTrail event processing...&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>batch_inference_input_file</span><span class=p>):</span>
    <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>batch_inference_input_file</span><span class=p>)</span>

<span class=n>event_count</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>page_count</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>completion_count</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>event_buffer</span> <span class=o>=</span> <span class=p>[]</span>

<span class=n>paginator</span> <span class=o>=</span> <span class=n>cloudtrail</span><span class=o>.</span><span class=n>get_paginator</span><span class=p>(</span><span class=s1>&#39;lookup_events&#39;</span><span class=p>)</span>
<span class=n>page_iterator</span> <span class=o>=</span> <span class=n>paginator</span><span class=o>.</span><span class=n>paginate</span><span class=p>(</span>
    <span class=n>PaginationConfig</span><span class=o>=</span><span class=p>{</span>
        <span class=s1>&#39;MaxItems&#39;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
        <span class=s1>&#39;PageSize&#39;</span><span class=p>:</span> <span class=mi>50</span>
    <span class=p>}</span>
<span class=p>)</span>

<span class=k>for</span> <span class=n>page</span> <span class=ow>in</span> <span class=n>page_iterator</span><span class=p>:</span>

    <span class=n>page_count</span> <span class=o>+=</span> <span class=mi>1</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\r</span><span class=s2>Processing page </span><span class=si>{</span><span class=n>page_count</span><span class=si>}</span><span class=s2> -&gt; batch entries created : </span><span class=si>{</span><span class=n>completion_count</span><span class=si>}</span><span class=s2>/[</span><span class=si>{</span><span class=n>min_batch_items_for_bedrock_batch_inference</span><span class=si>}</span><span class=s2>(min),</span><span class=si>{</span><span class=n>max_batch_items</span><span class=si>}</span><span class=s2>(max)]&quot;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>page</span><span class=p>[</span><span class=s1>&#39;Events&#39;</span><span class=p>]:</span>

        <span class=n>event_count</span> <span class=o>+=</span> <span class=mi>1</span>
        <span class=n>ct_event</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;CloudTrailEvent&#39;</span><span class=p>])</span>
        <span class=n>event_buffer</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ct_event</span><span class=p>)</span>

        <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>event_buffer</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>events_per_batch_item</span><span class=p>):</span>
            <span class=n>events_string</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>separators</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>))</span> <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>event_buffer</span><span class=p>)</span>

            <span class=n>create_batch_entry_and_add_to_file</span><span class=p>(</span><span class=n>events_string</span><span class=p>,</span> <span class=n>batch_inference_input_file</span><span class=p>)</span>

            <span class=n>event_buffer</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=n>completion_count</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=c1># stop if we have enough batch items, this limits the cost of the test in case if you have many events</span>
    <span class=k>if</span> <span class=n>completion_count</span> <span class=o>&gt;=</span> <span class=n>max_batch_items</span><span class=p>:</span>
        <span class=k>break</span>

    <span class=k>if</span> <span class=s1>&#39;NextToken&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>page</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Reached the end of available events.&quot;</span><span class=p>)</span>
        <span class=k>break</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>Total pages processed: </span><span class=si>{</span><span class=n>page_count</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Total events processed: </span><span class=si>{</span><span class=n>event_count</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Total completion count (items in batch inference): </span><span class=si>{</span><span class=n>completion_count</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=k>if</span> <span class=n>completion_count</span> <span class=o>&lt;</span> <span class=n>min_batch_items_for_bedrock_batch_inference</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Bedrock requires a minimum of </span><span class=si>{</span><span class=n>completion_count</span><span class=si>}</span><span class=s2> entries for batch inference. You may not have enough cloudtrail events.&quot;</span><span class=p>)</span>
</code></pre></div> <h3> Batch inference job</h3> <p>Batch inference input file is uploaded to S3 and passed as <code>inputDataConfig</code> eg. <code>input_file_name.jsonl</code><br></p> <div class=highlight><pre><span></span><code><span class=n>job_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;cloudtrail-summary-</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>&quot;</span>

<span class=n>s3</span><span class=o>.</span><span class=n>upload_file</span><span class=p>(</span><span class=n>batch_inference_input_file</span><span class=p>,</span> <span class=n>s3_bucket_name</span><span class=p>,</span> <span class=n>batch_inference_input_file</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Uploaded </span><span class=si>{</span><span class=n>batch_inference_input_file</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=n>s3_input_uri</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>response</span> <span class=o>=</span> <span class=n>bedrock</span><span class=o>.</span><span class=n>create_model_invocation_job</span><span class=p>(</span>
    <span class=n>modelId</span><span class=o>=</span><span class=n>model_id</span><span class=p>,</span>
    <span class=n>roleArn</span><span class=o>=</span><span class=n>role_arn</span><span class=p>,</span>
    <span class=n>jobName</span><span class=o>=</span><span class=n>job_name</span><span class=p>,</span>
    <span class=n>inputDataConfig</span><span class=o>=</span><span class=p>({</span>
        <span class=s2>&quot;s3InputDataConfig&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>&quot;s3Uri&quot;</span><span class=p>:</span> <span class=n>s3_input_uri</span>
        <span class=p>}</span>
    <span class=p>}),</span>
    <span class=n>outputDataConfig</span><span class=o>=</span><span class=p>({</span>
        <span class=s2>&quot;s3OutputDataConfig&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>&quot;s3Uri&quot;</span><span class=p>:</span> <span class=n>s3_output_uri</span>
        <span class=p>}</span>
    <span class=p>})</span>
<span class=p>)</span>

<span class=n>job_arn</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;jobArn&#39;</span><span class=p>)</span>
<span class=n>job_id</span> <span class=o>=</span> <span class=n>job_arn</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch inference job launched successfully. Job ID: </span><span class=si>{</span><span class=n>job_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Output will be available at: </span><span class=si>{</span><span class=n>s3_output_uri</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># wait for the job to complete, est. 10-20min</span>
<span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Waiting for job </span><span class=si>{</span><span class=n>job_arn</span><span class=si>}</span><span class=s2> to complete&quot;</span><span class=p>)</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>bedrock</span><span class=o>.</span><span class=n>get_model_invocation_job</span><span class=p>(</span><span class=n>jobIdentifier</span><span class=o>=</span><span class=n>job_arn</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Completed&#39;</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Done&quot;</span><span class=p>)</span>
        <span class=k>break</span>
    <span class=k>elif</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Failed&#39;</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch inference job failed: </span><span class=si>{</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;failureReason&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3> Batch inference output</h3> <p>Batch inference job output data configuration <code>outputDataConfig</code>is a folder where sub-folder <code>job-id</code> is created containing a <code>.out</code> file eg. <code>input_file_name.jsonl.out</code> with the completion results.<br> Each item processed by the batch inference job is a json object containing <code>modelInput</code> and <code>modelOutput</code> </p> <p>NOTE: a <code>manifest.json.out</code> is also generated and includes statistics on the batch job. eg. input tokens, output tokens.</p> <p>In this example, we download the <code>.out</code> file locally to process it.</p> <div class=highlight><pre><span></span><code><span class=n>output_file</span> <span class=o>=</span> <span class=s2>&quot;output.jsonl&quot;</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Downloading batch output from </span><span class=si>{</span><span class=n>s3_bucket_name</span><span class=si>}</span><span class=s2> for job </span><span class=si>{</span><span class=n>job_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>s3</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>s3_bucket_name</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;batch_inference_output/</span><span class=si>{</span><span class=n>job_id</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>batch_inference_input_file</span><span class=si>}</span><span class=s1>.out&#39;</span><span class=p>,</span> <span class=n>output_file</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Done.&quot;</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>

<span class=n>summaries</span> <span class=o>=</span> <span class=p>[]</span>

<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Processing </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>lines</span><span class=p>)</span><span class=si>}</span><span class=s2> lines to get the summaries&quot;</span><span class=p>)</span>
<span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
    <span class=n>summary</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;modelOutput&#39;</span><span class=p>][</span><span class=s2>&quot;content&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;text&quot;</span><span class=p>]</span>
    <span class=n>summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span>
</code></pre></div> <h3> Computing final summary</h3> <p>To compute the final summary we will group the summaries in prompt maxing out the configured context length.</p> <p>Direct calls to bedrock are made to summarize the groups of summaries.</p> <div class=highlight><pre><span></span><code><span class=c1># utility method to invoke bedrock and get result</span>
<span class=k>def</span> <span class=nf>invoke_bedrock</span><span class=p>(</span><span class=n>prompt</span><span class=p>):</span>

    <span class=n>native_request</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;anthropic_version&quot;</span><span class=p>:</span> <span class=s2>&quot;bedrock-2023-05-31&quot;</span><span class=p>,</span>
        <span class=s2>&quot;max_tokens&quot;</span><span class=p>:</span> <span class=mi>500</span><span class=p>,</span>
        <span class=s2>&quot;temperature&quot;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span>
        <span class=s2>&quot;messages&quot;</span><span class=p>:</span> <span class=p>[</span>
            <span class=p>{</span>
                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;text&quot;</span><span class=p>,</span> <span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
            <span class=p>}</span>
        <span class=p>],</span>
    <span class=p>}</span>

    <span class=c1># Convert the native request to JSON.</span>
    <span class=n>request</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>native_request</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=c1># Invoke the model with the request.</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>bedrock_runtime</span><span class=o>.</span><span class=n>invoke_model</span><span class=p>(</span><span class=n>modelId</span><span class=o>=</span><span class=n>model_id</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>request</span><span class=p>)</span>

    <span class=k>except</span> <span class=p>(</span><span class=n>ClientError</span><span class=p>,</span> <span class=ne>Exception</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;ERROR: Can&#39;t invoke &#39;</span><span class=si>{</span><span class=n>model_id</span><span class=si>}</span><span class=s2>&#39;. Reason: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

    <span class=n>model_response</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=p>[</span><span class=s2>&quot;body&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>

    <span class=n>response_text</span> <span class=o>=</span> <span class=n>model_response</span><span class=p>[</span><span class=s2>&quot;content&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;text&quot;</span><span class=p>]</span>

    <span class=k>return</span> <span class=n>response_text</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># prompt sent to bedrockto summarize a block of summaries generated by batch inference</span>
<span class=k>def</span> <span class=nf>summarize_block</span><span class=p>(</span><span class=n>to_summarize</span><span class=p>):</span>

    <span class=n>final_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&quot;&quot;Human: Please summarize the following summaries of AWS CloudTrail events. </span>
<span class=s2>        Focus on identifying patterns, unusual activities, and potential security concerns. </span>
<span class=s2>        Here&#39;s the list of summaries:</span>

<span class=s2>        </span><span class=si>{</span><span class=n>to_summarize</span><span class=si>}</span>

<span class=s2>        Provide a concise summary of the user&#39;s activities, highlighting any noteworthy or suspicious actions.</span>

<span class=s2>        Assistant: Certainly! I&#39;ll analyze the summaries and provide a final summary of their activities, focusing on patterns, unusual activities, and potential security concerns. Here&#39;s the final summary:</span>

<span class=s2>        &quot;&quot;&quot;</span>

    <span class=n>summary</span> <span class=o>=</span> <span class=n>invoke_bedrock</span><span class=p>(</span><span class=n>final_prompt</span><span class=p>)</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Summarized </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>to_summarize</span><span class=p>)</span><span class=si>}</span><span class=s2> chars with bedrock in </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span><span class=si>}</span><span class=s2> chars&quot;</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>summary</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=c1># processes the list of summaries to generate a final summary</span>
<span class=k>def</span> <span class=nf>summarize_list</span><span class=p>(</span><span class=n>summaries</span><span class=p>):</span>

    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Summarizing </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>summaries</span><span class=p>)</span><span class=si>}</span><span class=s2> summaries&quot;</span><span class=p>)</span>

    <span class=n>context_length</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>summaries_of_summaries</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>final_summary</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
    <span class=n>to_summarize</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
    <span class=n>count_summaries</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=k>for</span> <span class=n>summary</span> <span class=ow>in</span> <span class=n>summaries</span><span class=p>:</span>     

        <span class=n>count_summaries</span> <span class=o>+=</span> <span class=mi>1</span>

        <span class=n>context_length</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span>
        <span class=n>to_summarize</span> <span class=o>+=</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=n>summary</span>

        <span class=c1># we split summarization task by max_context_length given, </span>
        <span class=k>if</span> <span class=n>context_length</span> <span class=o>&gt;</span> <span class=n>max_context_length</span> <span class=o>-</span> <span class=n>prompt_length</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Processing summaries </span><span class=si>{</span><span class=n>count_summaries</span><span class=si>}</span><span class=s2> of </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>summaries</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
            <span class=n>summaries_of_summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summarize_block</span><span class=p>(</span><span class=n>to_summarize</span><span class=p>))</span>
            <span class=n>to_summarize</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
            <span class=n>context_length</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>to_summarize</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>summaries_of_summaries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summarize_block</span><span class=p>(</span><span class=n>to_summarize</span><span class=p>))</span>       

    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>summaries_of_summaries</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
        <span class=n>final_summary</span> <span class=o>=</span> <span class=n>summarize_list</span><span class=p>(</span><span class=n>summaries_of_summaries</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>final_summary</span> <span class=o>=</span> <span class=n>summaries_of_summaries</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

    <span class=k>return</span> <span class=n>final_summary</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=n>final_summary</span> <span class=o>=</span> <span class=n>summarize_list</span><span class=p>(</span><span class=n>summaries</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=nb>print</span><span class=p>(</span><span class=n>final_summary</span><span class=p>)</span>
</code></pre></div> <h3> Sample output 1</h3> <p>Based on the provided CloudTrail event summaries, the key observations regarding the user's activities are:</p> <ol> <li>Repeated CloudTrail API Calls by User "vivien":</li> <li>The IAM user "--redacted--" made multiple consecutive "LookupEvents" API calls to the CloudTrail service within a short timeframe, potentially indicating an attempt to retrieve a large amount of CloudTrail data.</li> <li>This user accessed the CloudTrail service from a non-AWS IP address (x.x.x.x) and used consistent user agent information (Boto3/1.35.8), suggesting an automated or scripted activity.</li> <li> <p>The repeated API calls and resulting throttling exceptions raise concerns about the user's intentions and the potential risk of unauthorized access or data exfiltration.</p> </li> <li> <p>Broad Role Permissions:</p> </li> <li>Some of the assumed roles, such as the "--redacted---" and the "--redacted---", have broad permissions (e.g., "Allow *" on all resources).</li> <li> <p>This level of broad access should be reviewed to ensure it is necessary and not overly permissive, as it could potentially lead to security risks if the roles are compromised.</p> </li> <li> <p>Security Audit Activities:</p> </li> <li>The user with the assumed role "--redacted---" performed a DescribeRegions operation, which is likely part of a security audit or monitoring activity.</li> <li>However, this user also attempted to retrieve the bucket policy for the "--redacted---" bucket, but received a "NoSuchBucketPolicy" error, indicating a potential permission issue.</li> <li>Additionally, the user accessed a bucket named "--redacted---", which is an unusual and potentially suspicious bucket name. This bucket access should be investigated further.</li> </ol> <p>In summary, the key concerns identified in the CloudTrail event summaries are the repeated CloudTrail API calls by the user "--redacted--", which could indicate unauthorized access or data exfiltration.</p> <h3> Sample output 2</h3> <p>Based on the analysis of the provided CloudTrail event summaries, the key findings are:</p> <ol> <li> <p>Routine CloudTrail Monitoring: The majority of the events are related to the CloudTrail service accessing S3 buckets to monitor and log API activities, which is a standard security practice.</p> </li> <li> <p>Assumed Roles by AWS Services: Various AWS services, such as Kinesis Analytics, SageMaker, Lightsail, and Pipes, are assuming specific IAM roles to perform their operations. This is a common and expected behavior for AWS services.</p> </li> <li> <p>Potential Security Concern: One event stands out where the SageMaker service assumed the "--redacted--" role, which grants broad permissions ("*" on all resources). While assuming roles is a normal practice, the broad permissions granted to this role could be a potential security concern and should be reviewed to ensure the role has the minimum required permissions.</p> </li> <li> <p>Unusual IAM User Activity: The IAM user "--redacted--" is performing a high volume of "InvokeModel" API calls on the "anthropic.claude-3-haiku-20240307-v1:0" model within a short timeframe. This pattern of repeated model invocations from a single user account could indicate potential unauthorized or abusive use of the AI/ML service.</p> </li> <li> <p>Potential Security Concern with Source IP: The source IP address "--redacted--" used by the "--redacted--" user is not a typical AWS IP range, which raises a potential security concern and warrants further investigation to ensure the legitimacy of the user's activities.</p> </li> </ol> <p>Overall, the CloudTrail event summaries do not indicate any clearly malicious or suspicious activities, aside from the unusual pattern of model invocations by the "--redacted--" user and the broad permissions granted to the SageMaker execution role. It is recommended to closely monitor the user's activities, review their permissions, investigate the source IP address, and ensure the principle of least privilege is followed for all IAM roles.</p> <h3> Publish to SNS topic</h3> <div class=highlight><pre><span></span><code><span class=c1># send to sns to receive the summary in email for eg.</span>
<span class=n>sns</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=n>TopicArn</span><span class=o>=</span><span class=n>sns_topic_arn</span><span class=p>,</span> <span class=n>Message</span><span class=o>=</span><span class=n>final_summary</span><span class=p>)</span>
</code></pre></div> <h2> Next steps</h2> <p>This sample is a baseline for anyone looking to enhance their security posture by analyzing CloudTrail logs using Amazon Bedrock. By following the steps outlined in the notebook, you can quickly set up and execute batch inference jobs that help you identify potential security threats in your AWS environment. Furthermore, the techniques demonstrated here can be applied to a wide range of other AWS services and use cases, making it a versatile addition to your cloud security toolkit. We encourage you to explore its capabilities, adapt it to your specific needs, and share your experiences with the community.</p> <p>Additionally, you can add the following features to enhance the solution: - parralelize the final summary processing to reduce latency of last step - filter out principals or services that are not believed to be interesting - break down by user, service, region - Integrate code in step function / lambda to to be able to trigger it on schedule - use IaC to create the resources</p> <p>For more examples and use cases, see: - <a href=batch-inference-transcript-summarization.md>Batch Inference for Call Center Transcripts</a> - <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/batch-inference.html target=_blank>Amazon Bedrock Batch Inference Documentation</a></p> <h2> Cleanup</h2> <p>Optionally, you can delete the resources created in the setup section through AWS console or CLI.</p> <ul> <li>Empty S3 bucket and delete the bucket</li> <li>Delete the SNS topic</li> <li>Delete the role</li> </ul> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by <a href="https://github.com/aws-samples/amazon-bedrock-samples/issues/new?title=[Online Feedback]: Short-Summary-of-Issue&body=Page URL: /introduction-to-bedrock/batch_api/batch-inference-cloudtrail-analyzer/" target=_blank rel=noopener>creating an issue</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved. </div> </div> <div class=md-social> <a href=https://github.com/aws-samples/amazon-bedrock-samples/tree/main target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["tags", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "navigation.footer", "search.highlight", "search.suggest"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "tags": {"Compatibility": "compat"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.88dd0f4e.min.js></script> <script src=../../../javascript/feedback.js></script> </body> </html>